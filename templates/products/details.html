{% extends "master/base.html" %}
{% load static %}
{% block content %}

<section class="section-content padding-y bg">
  <div class="container">
    <div class="card">
      <div class="row no-gutters">
        <aside class="col-md-6">
          <article class="gallery-wrap">
            <div class="img-big-wrap">
              <div class="main-image-container">
                <img
                  id="main-product-image"
                  src="{% if product.image %}{{ product.image.url }}{% else %}https://via.placeholder.com/500x500?text=No+Image{% endif %}"
                  alt="{{ product.name }}"
                  class="main-product-img"
                />
                <div class="image-overlay">
                  <button class="zoom-btn" onclick="openImageModal()">
                    <i class="fa fa-search-plus"></i>
                  </button>
                </div>
                
                <div class="product-badges-image">
                  {% if product.is_on_sale %}
                    <span class="badge badge-danger sale-badge">
                      {{ product.discount_percentage }}% OFF
                    </span>
                  {% endif %}
                  {% if product.product_type == 'thrift' %}
                    <span class="badge badge-success thrift-badge">‚ôªÔ∏è THRIFT</span>
                  {% elif product.product_type == 'refurbished' %}
                    <span class="badge badge-info refurbished-badge">üîß REFURBISHED</span>
                  {% endif %}
                  {% if product.condition %}
                    <span class="badge badge-secondary condition-badge">{{ product.get_condition_display }}</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="thumbnail-gallery" id="thumbnail-gallery">
              {% if product.image %}
              <div class="thumbnail-item active" onclick="changeMainImage('{{ product.image.url }}', this)">
                <img src="{{ product.image.url }}" alt="Default" class="thumbnail-img" />
              </div>
              {% endif %}
            </div>
          </article>
        </aside>

        <main class="col-md-6 border-left">
          <article class="content-body">
            <h2 class="title">{{ product.name }}</h2>

            <div class="mb-3">
              <div class="price-section">
                {% if product.is_on_sale and product.original_price %}
                  <var class="price h4 price-discounted" id="product-price">Rs. {{ product.get_final_price|floatformat:0 }}</var>
                  <del class="price-old h5 text-muted ml-2">Rs. {{ product.original_price|floatformat:0 }}</del>
                  <div class="savings-info mt-2">
                    <span class="badge badge-success savings-badge">
                      <i class="fa fa-tag"></i> Save Rs. {{ product.get_savings|floatformat:0 }} ({{ product.discount_percentage }}% OFF)
                    </span>
                  </div>
                {% else %}
                  <var class="price h4 price-regular" id="product-price">Rs. {{ product.price|floatformat:0 }}</var>
                {% endif %}
              </div>
            </div>

            <div class="product-badges-detail mb-3">
              {% if product.product_type == 'thrift' %}
                <span class="badge badge-success badge-enhanced mr-2">
                  <i class="fa fa-recycle"></i> ‚ôªÔ∏è THRIFT PRODUCT
                </span>
              {% elif product.product_type == 'refurbished' %}
                <span class="badge badge-info badge-enhanced mr-2">
                  <i class="fa fa-tools"></i> üîß REFURBISHED
                </span>
              {% endif %}
              
              {% if product.condition %}
                <span class="badge badge-secondary badge-enhanced mr-2">
                  <i class="fa fa-star"></i> Condition: {{ product.get_condition_display }}
                </span>
              {% endif %}
              
              {% if product.product_type == 'thrift' and product.years_used %}
                <span class="badge badge-light badge-enhanced">
                  <i class="fa fa-calendar"></i> Used for {{ product.years_used }} year{{ product.years_used|pluralize }}
                </span>
              {% endif %}
            </div>

            <p>{{ product.description }}</p>

            {% if product.has_variations %}
            <hr />
            
            <div id="stock-status" class="alert" style="display: none;">
              <span id="stock-message"></span>
            </div>
            
            <div class="product-variations">
              <form id="variation-form">
                {% for variation_type, variation_data in product.get_available_variations.items %}
                <div class="row mb-3">
                  <div class="col-12">
                    <div class="item-option-select" data-variation-type="{{ variation_type.name }}">
                      <h6>
                        {{ variation_data.type.display_name }}
                        {% if variation_data.is_required %} *{% endif %}
                        <span class="availability-info" id="availability-{{ variation_type.name }}" style="display: none;">
                          <small class="text-muted ml-2"></small>
                        </span>
                      </h6>

                      {% if variation_type.name == 'Color' %}
                        <div class="color-options d-flex flex-wrap">
                          {% for option in variation_data.options %}
                            {% with pv=option.product_variations.first %}
                            <label class="color-option mr-2 mb-2" data-option-id="{{ option.id }}">
                              <input
                                type="radio"
                                name="variation_{{ variation_type.id }}"
                                value="{{ option.id }}"
                                data-variation-type="{{ variation_type.name }}"
                                data-variation-value="{{ option.value }}"
                                data-price-adjustment="{% if pv %}{{ pv.price_adjustment }}{% else %}0{% endif %}"
                                {% if variation_data.is_required %}required{% endif %}
                                onchange="updateVariation()"
                              />
                              <span
                                class="color-swatch"
                                data-color="{% if option.color_code %}{{ option.color_code }}{% else %}{{ option.value|lower }}{% endif %}"
                                title="{{ option.get_display_value }}"
                              ></span>
                              <small class="color-name">{{ option.get_display_value }}</small>
                              <span class="stock-indicator" style="display: none;"></span>
                            </label>
                            {% endwith %}
                          {% endfor %}
                        </div>

                      {% elif variation_type.name == 'Size' %}
                        <div class="btn-group btn-group-sm btn-group-toggle size-options" data-toggle="buttons">
                          {% for option in variation_data.options %}
                            {% with pv=option.product_variations.first %}
                            <label class="btn btn-outline-primary size-option" data-option-id="{{ option.id }}">
                              <input
                                type="radio"
                                name="variation_{{ variation_type.id }}"
                                value="{{ option.id }}"
                                data-variation-type="{{ variation_type.name }}"
                                data-variation-value="{{ option.value }}"
                                data-price-adjustment="{% if pv %}{{ pv.price_adjustment }}{% else %}0{% endif %}"
                                {% if variation_data.is_required %}required{% endif %}
                                onchange="updateVariation()"
                              />
                              {{ option.get_display_value }}
                            </label>
                            {% endwith %}
                          {% endfor %}
                        </div>

                      {% else %}
                        <select
                          name="variation_{{ variation_type.id }}"
                          class="form-control variation-select"
                          style="max-width: 200px"
                          data-variation-type="{{ variation_type.name }}"
                          {% if variation_data.is_required %}required{% endif %}
                          onchange="updateVariation()"
                        >
                          <option value="">Choose {{ variation_type.display_name }}</option>
                          {% for option in variation_data.options %}
                            {% with pv=option.product_variations.first %}
                            <option
                              value="{{ option.id }}"
                              data-variation-value="{{ option.value }}"
                              data-price-adjustment="{% if pv %}{{ pv.price_adjustment }}{% else %}0{% endif %}"
                              data-option-id="{{ option.id }}"
                            >
                              {{ option.get_display_value }}
                            </option>
                            {% endwith %}
                          {% endfor %}
                        </select>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </form>
            </div>
            <hr />
            {% endif %}

            <div class="product-actions-section mb-4">
              <div class="d-flex align-items-center gap-3">
                <div class="flex-grow-1">
                  {% if product.stock <= 0 %}
                  <button class="btn btn-danger btn-lg w-100" disabled>
                    <i class="fas fa-times"></i> Out of Stock
                  </button>
                  {% else %}
                    {% if product.stock <= 5 %}
                    <p class="text-warning mb-2 small">Only {{ product.stock }} left in stock!</p>
                    {% endif %}
                    {% if in_cart %}
                    <button class="btn btn-success btn-lg w-100" disabled>
                      <i class="fas fa-check"></i> Added to Cart
                    </button>
                    <a href="{% url 'cart' %}" class="btn btn-outline-primary btn-lg w-100 mt-2">
                      <i class="fa fa-shopping-cart"></i> View Cart
                    </a>
                    {% else %}
                    <form action="{% url 'add_cart' product.id %}" method="POST" id="add-to-cart-form">
                      {% csrf_token %}
                      
                      <div id="selected-variations-container">
                      </div>
                      
                      <button type="submit" class="btn btn-primary btn-lg w-100" id="add-to-cart-btn">
                        <i class="fas fa-shopping-cart"></i> 
                        <span id="cart-btn-text">Add to Cart</span>
                      </button>
                    </form>
                    {% endif %}
                  {% endif %}
                </div>
                
                <div class="wishlist-container">
                  {% if user.is_authenticated %}
                  <button class="heart-wishlist-btn" 
                          data-product-id="{{ product.id }}"
                          data-in-wishlist="{% if product.id in user_wishlist_ids %}true{% else %}false{% endif %}"
                          title="{% if product.id in user_wishlist_ids %}Remove from wishlist{% else %}Add to wishlist{% endif %}">
                    <i class="fa fa-heart {% if product.id in user_wishlist_ids %}filled{% endif %}"></i>
                  </button>
                  {% else %}
                  <a href="{% url 'login' %}" class="heart-wishlist-btn" title="Login to save to wishlist">
                    <i class="fa fa-heart"></i>
                  </a>
                  {% endif %}
                </div>
              </div>
            </div>

            {% if product.seller %}
            <hr class="my-4" />
            <div class="seller-info-section">
              <div class="card border-0 bg-light">
                <div class="card-body p-3">
                  <h6 class="card-title mb-3">
                    <i class="fa fa-store text-primary"></i> Sold by
                  </h6>

                  <div class="row align-items-center">
                    <div class="col-3">
                      <a href="{% url 'products:seller_products' product.seller.id %}" class="seller-link">
                        {% if product.seller.profile.profile_picture %}
                        <img
                          src="{{ product.seller.profile.profile_picture.url }}"
                          class="rounded-circle seller-avatar"
                          alt="{{ product.seller.get_full_name|default:product.seller.username }}"
                        />
                        {% else %}
                        <div class="seller-initials rounded-circle d-flex align-items-center justify-content-center" 
                             id="seller-initials">
                          <span class="seller-initials-text"></span>
                        </div>
                        {% endif %}
                      </a>
                    </div>

                    <div class="col-9">
                      <div class="seller-details">
                        <h6 class="seller-name mb-1">
                          <a href="{% url 'products:seller_products' product.seller.id %}" class="text-decoration-none">
                            {% if product.seller.profile.business_name %}
                              {{ product.seller.profile.business_name }}
                            {% else %}
                              {{ product.seller.get_full_name|default:product.seller.username }}
                            {% endif %}
                          </a>
                          {% if product.seller.profile.seller_status == 'approved' %}
                          <span class="badge badge-success badge-sm ml-1">
                            <i class="fa fa-check-circle"></i> Verified
                          </span>
                          {% endif %}
                        </h6>

                        {% if product.seller.profile.business_description %}
                        <p class="text-muted small mb-2">
                          {{ product.seller.profile.business_description|truncatewords:12 }}
                        </p>
                        {% endif %}

                        <div class="seller-stats small text-muted mb-2">
                          <span class="mr-3">
                            <i class="fa fa-box"></i>
                            {{ seller_product_count }} Products
                          </span>
                          <span>
                            <i class="fa fa-calendar"></i>
                            Since {{ product.seller.date_joined|date:"M Y" }}
                          </span>
                        </div>

                        <div class="seller-actions">
                          <a href="{% url 'products:seller_products' product.seller.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="fa fa-store"></i> View Shop
                          </a>
                          <button class="btn btn-outline-success btn-sm ml-2" onclick="openChat(this)" data-seller-id="{{ product.seller.id }}">
                            <i class="fa fa-comments"></i> Chat
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          </article>
        </main>
      </div>
    </div>

    <br />

    <div class="row">
      <div class="col-md-9">
        <header class="section-heading">
          <h3>Customer Reviews</h3>
        </header>

        {% for review in reviews %}
        <article class="box mb-3">
          <div class="icontext w-100">
            {% if review.user.profile.profile_picture %}
  <img
    src="{{ review.user.profile.profile_picture.url }}"
    class="img-xs icon rounded-circle"
    alt="{{ review.user.get_full_name|default:review.user.username }}"
    style="object-fit: cover; width: 48px; height: 48px;"
  />
{% else %}
  <img
    src="{% static 'images/default/default-user.png' %}"
    class="img-xs icon rounded-circle"
    alt="Default avatar"
    style="object-fit: cover; width: 48px; height: 48px;"
  />
{% endif %}
            <div class="text">
              <span class="date text-muted float-md-right">{{ review.created_at|date:"d.m.Y" }}</span>
              <h6 class="mb-1">
                {{ review.user.first_name }} {{ review.user.last_name }}
                {% if review.verified_purchase %}
                <span class="badge badge-success badge-sm ml-2">Verified Purchase</span>
                {% endif %}
              </h6>
              <div class="rating-star">
                {% for i in "12345"|make_list %}
                  {% if forloop.counter <= review.rating %}
                    <i class="fa fa-star text-warning"></i>
                  {% else %}
                    <i class="fa fa-star text-muted"></i>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>
          <div class="mt-3">
            <h6>{{ review.subject }}</h6>
            <p>{{ review.review }}</p>
          </div>
        </article>
        {% empty %}
        <p>No reviews yet.</p>
        {% endfor %}

        <hr class="my-4" />

        <div class="review-form-section">
          {% if user.is_authenticated %}
            {% if user_can_review %}
              {% if not user_has_reviewed %}
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">
                    <i class="fa fa-star text-warning"></i> Write a Review
                  </h5>
                </div>
                <div class="card-body">
                  <form method="POST" action="{% url 'products:submit_review' product.id %}" id="review-form">
                    {% csrf_token %}

                    <div class="form-group">
                      <label for="rating">Rating *</label>
                      <div class="rating-input">
                        <div class="rating-stars" id="rating-stars">
                          <i class="fa fa-star" data-rating="1"></i>
                          <i class="fa fa-star" data-rating="2"></i>
                          <i class="fa fa-star" data-rating="3"></i>
                          <i class="fa fa-star" data-rating="4"></i>
                          <i class="fa fa-star" data-rating="5"></i>
                        </div>
                        <input type="hidden" name="rating" id="rating-value" required />
                        <small class="form-text text-muted">Click on stars to rate</small>
                      </div>
                    </div>

                    <div class="form-group">
                      <label for="subject">Review Title</label>
                      <input
                        type="text"
                        class="form-control"
                        name="subject"
                        id="subject"
                        placeholder="Summary of your review"
                        maxlength="100"
                      />
                    </div>

                    <div class="form-group">
                      <label for="review">Your Review</label>
                      <textarea
                        class="form-control"
                        name="review"
                        id="review"
                        rows="4"
                        placeholder="Share your thoughts about this product..."
                        maxlength="500"
                      ></textarea>
                      <small class="form-text text-muted">Maximum 500 characters</small>
                    </div>

                    <button type="submit" class="btn btn-primary">
                      <i class="fa fa-paper-plane"></i> Submit Review
                    </button>
                  </form>
                </div>
              </div>
              {% else %}
              <div class="alert alert-info">
                <i class="fa fa-info-circle"></i>
                <strong>Thank you!</strong> You have already reviewed this product.
              </div>
              {% endif %}
            {% else %}
            <div class="alert alert-warning">
              <i class="fa fa-shopping-bag"></i>
              <strong>Purchase Required:</strong> You can only review products you have purchased and received.
            </div>
            {% endif %}
          {% else %}
          <div class="alert alert-secondary">
            <i class="fa fa-user"></i>
            Please <a href="{% url 'login' %}" class="alert-link">login</a> to write a review.
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body p-0">
        <img id="modal-image" src="" class="w-100" alt="Product Image" />
        <button type="button" class="close modal-close-btn" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script id="django-data" type="application/json">
{
  "basePrice": {% if product.is_on_sale and product.get_final_price %}{{ product.get_final_price }}{% else %}{{ product.price }}{% endif %},
  "productId": {{ product.id }},
  "variationImages": {{ variation_images_json|safe }},
  "defaultImage": "{% if product.image %}{{ product.image.url }}{% endif %}",
  "hasVariations": {% if product.has_variations %}true{% else %}false{% endif %},
  "variationStock": {{ variation_stock_json|safe }},
  "availableCombinations": {{ available_combinations_json|safe }}
}
</script>

<style>
.product-badges-image {
  position: absolute;
  top: 15px;
  left: 15px;
  z-index: 10;
}

.product-badges-image .badge {
  display: block;
  margin-bottom: 8px;
  font-size: 12px;
  font-weight: bold;
  padding: 6px 12px;
  border-radius: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.sale-badge {
  background: linear-gradient(45deg, #ff6b6b, #ff5722) !important;
  animation: pulse 2s infinite;
  color: white !important;
}

.thrift-badge {
  background: linear-gradient(45deg, #4caf50, #2e7d32) !important;
  color: white !important;
}

.refurbished-badge {
  background: linear-gradient(45deg, #2196f3, #1976d2) !important;
  color: white !important;
}

.condition-badge {
  background: linear-gradient(45deg, #6c757d, #495057) !important;
  color: white !important;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.price-section {
  padding: 20px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  border-left: 4px solid #28a745;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}

.price-section:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
}

.price-discounted {
  color: #28a745 !important;
}

.price-regular {
  color: #007bff !important;
}

.price-old {
  text-decoration: line-through;
}

.savings-badge {
  font-size: 0.85rem;
  padding: 8px 15px;
  border-radius: 20px;
  background: linear-gradient(45deg, #28a745, #20c997) !important;
  animation: fadeInBounce 0.5s ease-out;
}

@keyframes fadeInBounce {
  0% { opacity: 0; transform: scale(0.8); }
  50% { transform: scale(1.05); }
  100% { opacity: 1; transform: scale(1); }
}

.product-badges-detail .badge-enhanced {
  font-size: 0.85rem;
  padding: 10px 15px;
  border-radius: 20px;
  margin-bottom: 8px;
  display: inline-block;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  animation: slideInFromLeft 0.6s ease-out;
}

.product-badges-detail .badge-enhanced:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.product-badges-detail .badge-success {
  background: linear-gradient(45deg, #4caf50, #2e7d32) !important;
}

.product-badges-detail .badge-info {
  background: linear-gradient(45deg, #2196f3, #1976d2) !important;
}

.product-badges-detail .badge-secondary {
  background: linear-gradient(45deg, #6c757d, #495057) !important;
}

.product-badges-detail .badge-light {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
  color: #6c757d !important;
  border: 2px solid #dee2e6;
}

@keyframes slideInFromLeft {
  0% { opacity: 0; transform: translateX(-30px); }
  100% { opacity: 1; transform: translateX(0); }
}

.gallery-wrap {
  position: sticky;
  top: 20px;
  width: 100%;
}

.main-image-container {
  position: relative;
  overflow: hidden;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  background: #f8f9fa;
  width: 100%;
}

.main-product-img {
  width: 100%;
  height: 400px;
  object-fit: cover;
  transition: transform 0.3s ease;
  cursor: zoom-in;
  border-radius: 8px;
  background: #f8f9fa;
}

.main-product-img:hover {
  transform: scale(1.05);
}

.image-overlay {
  position: absolute;
  top: 15px;
  right: 15px;
  opacity: 0;
  transition: opacity 0.3s;
}

.main-image-container:hover .image-overlay {
  opacity: 1;
}

.zoom-btn {
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: none;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 16px;
}

.zoom-btn:hover {
  background: rgba(0, 0, 0, 0.9);
  transform: scale(1.1);
}

.thumbnail-gallery {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 15px;
  max-height: 120px;
  overflow-y: auto;
  padding: 5px;
}

.thumbnail-item {
  cursor: pointer;
  border: 3px solid transparent;
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.3s ease;
  flex-shrink: 0;
  background: #fff;
}

.thumbnail-item:hover {
  border-color: #007bff;
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
}

.thumbnail-item.active {
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
  transform: scale(1.05);
}

.thumbnail-img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  display: block;
  transition: transform 0.3s;
}

.thumbnail-item:hover .thumbnail-img {
  transform: scale(1.1);
}

.modal-close-btn {
  position: absolute;
  top: 15px;
  right: 25px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  border: none;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  font-size: 20px;
  cursor: pointer;
  transition: background 0.3s;
}

.modal-close-btn:hover {
  background: rgba(0, 0, 0, 1);
}

.color-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
}

.color-option:hover {
  transform: translateY(-2px);
}

.color-option input[type="radio"] {
  position: absolute;
  opacity: 0;
}

.color-swatch {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  border: 3px solid #ddd;
  display: block;
  transition: all 0.3s ease;
  position: relative;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.color-option input[type="radio"]:checked + .color-swatch {
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
  transform: scale(1.15);
}

.color-option input[type="radio"]:checked + .color-swatch:after {
  content: "‚úì";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-weight: bold;
  font-size: 16px;
  text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
}

.color-name {
  margin-top: 6px;
  font-size: 11px;
  text-align: center;
  font-weight: 500;
}

.color-option.unavailable {
  opacity: 0.4;
  pointer-events: none;
}

.color-option.unavailable .color-swatch {
  position: relative;
  overflow: hidden;
}

.color-option.unavailable .color-swatch::before {
  content: '';
  position: absolute;
  top: 50%;
  left: -10%;
  right: -10%;
  height: 3px;
  background: #dc3545;
  transform: translateY(-50%) rotate(-15deg);
  z-index: 10;
  box-shadow: 0 0 0 2px white, 0 0 0 3px #dc3545;
}

.btn-group-toggle .btn {
  min-width: 55px;
  transition: all 0.3s;
}

.btn-group-toggle .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

.size-option.unavailable {
  opacity: 0.4;
  pointer-events: none;
  position: relative;
}

.size-option.unavailable::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 10%;
  right: 10%;
  height: 3px;
  background: #dc3545;
  transform: translateY(-50%) rotate(-10deg);
  z-index: 10;
}

.variation-select option:disabled {
  color: #999;
  background-color: #f5f5f5;
}

.stock-indicator {
  position: absolute;
  top: -5px;
  right: -5px;
  background: white;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.stock-indicator.low-stock {
  background: #ffc107;
  color: white;
}

.stock-indicator.out-of-stock {
  background: #dc3545;
  color: white;
}

.availability-info {
  font-style: italic;
}

.seller-info-section {
  margin-top: 25px;
}

.seller-avatar {
  width: 75px;
  height: 75px;
  object-fit: cover;
  transition: transform 0.3s;
  border: 3px solid #fff;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.seller-avatar:hover {
  transform: scale(1.1);
}

.seller-initials {
  width: 75px;
  height: 75px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: 3px solid #e9ecef;
  color: white;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.seller-initials:hover {
  transform: scale(1.1);
  border-color: #007bff;
}

.seller-initials-text {
  font-size: 1.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.seller-initials.color-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.seller-initials.color-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.seller-initials.color-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.seller-initials.color-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.seller-initials.color-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
.seller-initials.color-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
.seller-initials.color-7 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
.seller-initials.color-8 { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }

.seller-link {
  text-decoration: none;
}

.seller-name a {
  color: #495057;
  font-weight: 700;
  transition: color 0.3s;
}

.seller-name a:hover {
  color: #007bff;
}

.seller-stats {
  border-top: 1px solid #dee2e6;
  padding-top: 10px;
  margin-top: 8px;
}

.seller-actions .btn {
  font-size: 12px;
  padding: 6px 12px;
  transition: all 0.3s;
}

.seller-actions .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.rating-stars {
  font-size: 28px;
  margin-bottom: 15px;
}

.rating-stars i {
  color: #ddd;
  cursor: pointer;
  transition: all 0.2s;
  margin-right: 5px;
}

.rating-stars i:hover,
.rating-stars i.active {
  color: #ffc107;
  transform: scale(1.2);
}

.rating-stars i.active ~ i {
  color: #ddd;
  transform: scale(1);
}

.product-actions-section {
  padding: 20px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  border: 2px solid #e9ecef;
  margin: 20px 0;
}

.product-actions-section .d-flex.gap-3 {
  gap: 15px !important;
}

.wishlist-container {
  flex-shrink: 0;
}

.heart-wishlist-btn {
  width: 56px !important;
  height: 56px !important;
  border: 2px solid #e1e5e9 !important;
  background: white !important;
  border-radius: 50% !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
  cursor: pointer !important;
  text-decoration: none !important;
  position: relative !important;
  overflow: hidden !important;
}

.heart-wishlist-btn:hover {
  transform: translateY(-2px) scale(1.05) !important;
  box-shadow: 0 8px 25px rgba(220, 53, 69, 0.25) !important;
  border-color: #ff4757 !important;
  text-decoration: none !important;
}

.heart-wishlist-btn:focus {
  outline: none !important;
  box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2) !important;
}

.heart-wishlist-btn i {
  font-size: 22px !important;
  color: #8e9aaf !important;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
  position: relative !important;
  z-index: 2 !important;
}

.heart-wishlist-btn[data-in-wishlist="true"] {
  background: linear-gradient(135deg, #ff4757, #ff3838) !important;
  border-color: #ff4757 !important;
  box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4) !important;
}

.heart-wishlist-btn[data-in-wishlist="true"] i.filled {
  color: white !important;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
  animation: heartPulse 0.6s ease-in-out !important;
}

.heart-wishlist-btn[data-in-wishlist="true"]:hover {
  background: linear-gradient(135deg, #ff3838, #ff2929) !important;
  transform: translateY(-2px) scale(1.05) !important;
  box-shadow: 0 8px 25px rgba(255, 71, 87, 0.5) !important;
}

.heart-wishlist-btn:hover i {
  color: #ff4757 !important;
  transform: scale(1.1) !important;
}

.heart-wishlist-btn.loading {
  opacity: 0.7 !important;
  pointer-events: none !important;
}

.heart-wishlist-btn.loading i {
  animation: spin 1s linear infinite !important;
}

.product-actions-section .btn-lg {
  padding: 12px 24px !important;
  font-size: 16px !important;
  font-weight: 600 !important;
  border-radius: 8px !important;
  transition: all 0.3s ease !important;
  text-decoration: none !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 8px !important;
  min-height: 56px !important;
}

.product-actions-section .btn-lg:hover {
  transform: translateY(-1px) !important;
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3) !important;
  text-decoration: none !important;
}

@keyframes heartPulse {
  0% { transform: scale(1); }
  15% { transform: scale(1.3); }
  30% { transform: scale(1); }
  45% { transform: scale(1.2); }
  60% { transform: scale(1); }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

@media (max-width: 768px) {
  .heart-wishlist-btn {
    width: 48px !important;
    height: 48px !important;
  }
  
  .heart-wishlist-btn i {
    font-size: 18px !important;
  }
  
  .product-actions-section .d-flex.gap-3 {
    gap: 10px !important;
  }
  
  .product-actions-section .btn-lg {
    font-size: 14px !important;
    padding: 10px 20px !important;
    min-height: 48px !important;
  }
}

@media (max-width: 576px) {
  .heart-wishlist-btn {
    width: 44px !important;
    height: 44px !important;
  }
  
  .heart-wishlist-btn i {
    font-size: 16px !important;
  }
  
  .product-actions-section {
    padding: 15px !important;
  }
  
  .product-actions-section .d-flex.gap-3 {
    gap: 8px !important;
  }
}

@media (min-width: 992px) {
  .main-product-img {
    height: 500px;
  }
}

@media (max-width: 991px) and (min-width: 768px) {
  .main-product-img {
    height: 350px;
  }
}

@media (max-width: 767px) {
  .main-product-img {
    height: 300px;
  }
  
  .thumbnail-img {
    width: 60px;
    height: 60px;
  }
  
  .seller-avatar,
  .seller-initials {
    width: 60px;
    height: 60px;
  }
  
  .seller-initials-text {
    font-size: 1.4rem;
  }
  
  .color-swatch {
    width: 35px;
    height: 35px;
  }
  
  .gallery-wrap {
    position: relative;
  }
  
  .product-badges-image {
    top: 10px;
    left: 10px;
  }
  
  .product-badges-image .badge {
    font-size: 10px;
    padding: 4px 8px;
    margin-bottom: 5px;
  }
}

@media (max-width: 576px) {
  .thumbnail-gallery {
    max-height: 100px;
  }
  
  .color-options {
    justify-content: center;
  }
  
  .seller-actions {
    text-align: center;
    margin-top: 10px;
  }
  
  .product-badges-detail .badge-enhanced {
    font-size: 0.75rem;
    padding: 8px 12px;
    margin-bottom: 6px;
  }
}
</style>

<script>
let productData;
try {
  const djangoDataElement = document.getElementById("django-data");
  productData = JSON.parse(djangoDataElement.textContent);
} catch (e) {
  console.error("Error loading product data:", e);
  productData = {
    basePrice: 0,
    productId: 0,
    variationImages: {},
    defaultImage: "",
    hasVariations: false,
    variationStock: {},
    availableCombinations: {}
  };
}

let selectedVariations = {};

function getAvailableOptions(variationType) {
  if (!productData.hasVariations || !productData.availableCombinations) {
    return [];
  }

  const otherSelections = {};
  Object.keys(selectedVariations).forEach(type => {
    if (type !== variationType) {
      otherSelections[type] = selectedVariations[type];
    }
  });

  const availableOptions = new Set();

  Object.values(productData.availableCombinations).forEach(combination => {
    if (combination.stock > 0) {
      let matches = true;
      Object.keys(otherSelections).forEach(type => {
        if (combination[type] !== otherSelections[type]) {
          matches = false;
        }
      });
      
      if (matches && combination[variationType]) {
        availableOptions.add(combination[variationType].toString());
      }
    }
  });

  return Array.from(availableOptions);
}

function updateAvailableOptions() {
  if (!productData.hasVariations) return;

  const variationGroups = document.querySelectorAll('.item-option-select');
  
  variationGroups.forEach(group => {
    const variationType = group.dataset.variationType;
    const availableOptions = getAvailableOptions(variationType);
    
    const colorOptions = group.querySelectorAll('.color-option');
    colorOptions.forEach(option => {
      const optionId = option.dataset.optionId;
      if (availableOptions.includes(optionId)) {
        option.classList.remove('unavailable');
        const input = option.querySelector('input');
        if (input) input.disabled = false;
      } else {
        option.classList.add('unavailable');
        const input = option.querySelector('input');
        if (input) {
          input.disabled = true;
          if (input.checked) {
            input.checked = false;
            delete selectedVariations[variationType];
          }
        }
      }
    });

    const sizeOptions = group.querySelectorAll('.size-option');
    sizeOptions.forEach(option => {
      const optionId = option.dataset.optionId;
      if (availableOptions.includes(optionId)) {
        option.classList.remove('unavailable');
        const input = option.querySelector('input');
        if (input) input.disabled = false;
      } else {
        option.classList.add('unavailable');
        const input = option.querySelector('input');
        if (input) {
          input.disabled = true;
          if (input.checked) {
            input.checked = false;
            delete selectedVariations[variationType];
          }
        }
      }
    });

    const selectElement = group.querySelector('select');
    if (selectElement) {
      const options = selectElement.querySelectorAll('option[data-option-id]');
      options.forEach(option => {
        const optionId = option.dataset.optionId;
        if (availableOptions.includes(optionId)) {
          option.disabled = false;
          option.style.display = '';
        } else {
          option.disabled = true;
          if (option.selected) {
            selectElement.value = '';
            delete selectedVariations[variationType];
          }
        }
      });
    }
  });
}

function getCurrentCombinationStock() {
  if (!productData.hasVariations || Object.keys(selectedVariations).length === 0) {
    return null;
  }

  const combination = Object.values(productData.availableCombinations || {}).find(combo => {
    return Object.keys(selectedVariations).every(type => {
      return combo[type] && combo[type].toString() === selectedVariations[type].toString();
    });
  });

  return combination ? combination.stock : 0;
}

function updateStockStatus() {
  const stockStatus = document.getElementById('stock-status');
  const stockMessage = document.getElementById('stock-message');
  const cartBtn = document.getElementById('add-to-cart-btn');
  const cartBtnText = document.getElementById('cart-btn-text');
  
  if (!stockStatus || !stockMessage) return;

  const selectedCount = Object.keys(selectedVariations).length;
  const totalVariations = productData.hasVariations ? document.querySelectorAll('.item-option-select').length : 0;

  if (selectedCount === 0) {
    stockStatus.style.display = 'none';
    if (cartBtn && cartBtnText) {
      cartBtn.disabled = totalVariations > 0;
      cartBtnText.textContent = totalVariations > 0 ? 'Select Options' : 'Add to Cart';
    }
    return;
  }

  if (selectedCount < totalVariations) {
    stockStatus.style.display = 'none';
    if (cartBtn && cartBtnText) {
      cartBtn.disabled = true;
      cartBtnText.textContent = `Select ${totalVariations - selectedCount} More Option${totalVariations - selectedCount > 1 ? 's' : ''}`;
    }
    return;
  }

  const stock = getCurrentCombinationStock();
  
  if (stock === null) {
    stockStatus.style.display = 'none';
  } else if (stock <= 0) {
    stockStatus.className = 'alert alert-danger';
    stockMessage.innerHTML = '<i class="fas fa-times-circle"></i> This combination is out of stock';
    stockStatus.style.display = 'block';
    if (cartBtn && cartBtnText) {
      cartBtn.disabled = true;
      cartBtnText.textContent = 'Out of Stock';
    }
  } else if (stock <= 5) {
    stockStatus.className = 'alert alert-warning';
    stockMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Only ${stock} left for this combination`;
    stockStatus.style.display = 'block';
    if (cartBtn && cartBtnText) {
      cartBtn.disabled = false;
      cartBtnText.textContent = 'Add to Cart';
    }
  } else {
    stockStatus.className = 'alert alert-success';
    stockMessage.innerHTML = '<i class="fas fa-check-circle"></i> In stock';
    stockStatus.style.display = 'block';
    if (cartBtn && cartBtnText) {
      cartBtn.disabled = false;
      cartBtnText.textContent = 'Add to Cart';
    }
  }
}

function initializeSellerInitials() {
    const hasSellerProfilePic = {% if product.seller.profile.profile_picture %}true{% else %}false{% endif %};
    
    if (!hasSellerProfilePic) {
        showSellerInitials();
    }
}

function showSellerInitials() {
    const firstName = "{{ product.seller.first_name|default:'' }}";
    const lastName = "{{ product.seller.last_name|default:'' }}";
    const username = "{{ product.seller.username|default:'' }}";
    const businessName = "{{ product.seller.profile.business_name|default:'' }}";
    
    let initials = '';
    
    if (businessName) {
        const words = businessName.trim().split(' ');
        if (words.length >= 2) {
            initials = words[0].charAt(0) + words[1].charAt(0);
        } else {
            initials = businessName.charAt(0) + (businessName.charAt(1) || '');
        }
    } else if (firstName && lastName) {
        initials = firstName.charAt(0) + lastName.charAt(0);
    } else if (firstName) {
        initials = firstName.charAt(0) + (firstName.charAt(1) || '');
    } else if (username) {
        initials = username.charAt(0) + (username.charAt(1) || '');
    } else {
        initials = 'S';
    }
    
    const initialsElement = document.getElementById('seller-initials');
    const initialsText = initialsElement.querySelector('.seller-initials-text');
    
    if (initialsText) {
        initialsText.textContent = initials.toUpperCase();
        
        const colorIndex = (initials.charCodeAt(0) % 8) + 1;
        initialsElement.classList.add(`color-${colorIndex}`);
        
        initialsElement.style.display = 'flex';
    }
}

function setColorSwatches() {
  document.querySelectorAll(".color-swatch[data-color]").forEach(function (swatch) {
    const color = swatch.getAttribute("data-color");
    swatch.style.backgroundColor = color;
  });
}

function changeMainImage(imageUrl, thumbnailElement) {
  const mainImage = document.getElementById("main-product-image");
  if (!mainImage) return;

  mainImage.style.opacity = "0.5";
  setTimeout(function () {
    mainImage.src = imageUrl;
    mainImage.style.opacity = "1";
  }, 150);

  document.querySelectorAll(".thumbnail-item").forEach(function (item) {
    item.classList.remove("active");
  });
  if (thumbnailElement) {
    thumbnailElement.classList.add("active");
  }
}

function updateThumbnailGallery(images) {
  const gallery = document.getElementById("thumbnail-gallery");
  if (!gallery) return;

  gallery.innerHTML = "";

  if (!images || images.length === 0) {
    if (productData.defaultImage) {
      images = [productData.defaultImage];
    } else {
      gallery.style.display = "none";
      return;
    }
  }

  gallery.style.display = "flex";

  images.forEach(function (imageUrl, index) {
    const thumbnailDiv = document.createElement("div");
    thumbnailDiv.className = "thumbnail-item" + (index === 0 ? " active" : "");
    thumbnailDiv.onclick = function () {
      changeMainImage(imageUrl, thumbnailDiv);
    };

    const img = document.createElement("img");
    img.src = imageUrl;
    img.className = "thumbnail-img";
    img.alt = "Image " + (index + 1);

    img.onerror = function () {
      this.src = "https://via.placeholder.com/80x80?text=No+Image";
    };

    thumbnailDiv.appendChild(img);
    gallery.appendChild(thumbnailDiv);
  });

  if (images.length > 0) {
    changeMainImage(images[0], gallery.querySelector(".thumbnail-item"));
  }
}

function openImageModal() {
  const currentImage = document.getElementById("main-product-image");
  const modalImage = document.getElementById("modal-image");
  if (currentImage && modalImage) {
    modalImage.src = currentImage.src;
    $("#imageModal").modal("show");
  }
}

function updateVariation() {
  const form = document.getElementById("variation-form");
  if (!form) return;

  selectedVariations = {};

  const checkedInputs = form.querySelectorAll("input:checked");
  checkedInputs.forEach(function (input) {
    const variationType = input.dataset.variationType;
    const value = input.value;
    if (variationType && value) {
      selectedVariations[variationType] = value;
    }
  });

  const selects = form.querySelectorAll("select");
  selects.forEach(function (select) {
    const variationType = select.dataset.variationType;
    const value = select.value;
    if (variationType && value) {
      selectedVariations[variationType] = value;
    }
  });

  updateAvailableOptions();
  updateStockStatus();
  updatePrice();
  updateImages();
  updateCartForm();
}

function updateCartForm() {
  const container = document.getElementById('selected-variations-container');
  const variationForm = document.getElementById('variation-form');
  
  if (!container || !variationForm) return;
  
  container.innerHTML = '';
  
  const selectedVariationsList = [];
  
  const checkedInputs = variationForm.querySelectorAll('input[type="radio"]:checked, input[type="checkbox"]:checked');
  checkedInputs.forEach(function(input) {
    const name = input.name;
    const value = input.value;
    if (name && value) {
      selectedVariationsList.push({name: name, value: value});
    }
  });
  
  const selects = variationForm.querySelectorAll('select');
  selects.forEach(function(select) {
    if (select.value && select.name) {
      selectedVariationsList.push({name: select.name, value: select.value});
    }
  });
  
  selectedVariationsList.forEach(function(variation) {
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = variation.name;
    hiddenInput.value = variation.value;
    container.appendChild(hiddenInput);
  });
}

function validateCartForm() {
  const variationForm = document.getElementById('variation-form');
  if (!variationForm) return true;
  
  const requiredInputs = variationForm.querySelectorAll('input[required], select[required]');
  for (let input of requiredInputs) {
    if (input.type === 'radio') {
      const name = input.name;
      const checkedInput = variationForm.querySelector(`input[name="${name}"]:checked`);
      if (!checkedInput) {
        alert(`Please select a ${input.dataset.variationType || 'variation'}`);
        return false;
      }
    } else if (input.tagName === 'SELECT') {
      if (!input.value) {
        alert(`Please select a ${input.dataset.variationType || 'variation'}`);
        return false;
      }
    }
  }
  
  return true;
}

function updatePrice() {
  let totalAdjustment = 0;

  const form = document.getElementById("variation-form");
  if (form) {
    const checkedInputs = form.querySelectorAll("input:checked");
    checkedInputs.forEach(function (input) {
      const adjustment = parseFloat(input.getAttribute("data-price-adjustment") || 0);
      totalAdjustment += adjustment;
    });

    const selects = form.querySelectorAll("select");
    selects.forEach(function (select) {
      const selectedOption = select.options[select.selectedIndex];
      if (selectedOption && selectedOption.value) {
        const adjustment = parseFloat(selectedOption.getAttribute("data-price-adjustment") || 0);
        totalAdjustment += adjustment;
      }
    });
  }

  if (totalAdjustment !== 0) {
    const newPrice = productData.basePrice + totalAdjustment;
    const priceElement = document.getElementById("product-price");
    if (priceElement) {
      priceElement.style.color = "#007bff";
      priceElement.textContent = "Rs." + newPrice.toFixed(0);
      setTimeout(function () {
        priceElement.style.color = "";
      }, 500);
    }
  }
}

function updateImages() {
  const colorInput = document.querySelector('input[data-variation-type="Color"]:checked');

  if (colorInput && colorInput.value) {
    const optionId = colorInput.value.toString();

    if (productData.variationImages[optionId] && productData.variationImages[optionId].length > 0) {
      updateThumbnailGallery(productData.variationImages[optionId]);
      return;
    }
  }

  if (productData.defaultImage) {
    updateThumbnailGallery([productData.defaultImage]);
  }
}

function openChat(button) {
    const sellerId = button.getAttribute("data-seller-id");
    window.location.href = `{% url 'start_chat_about_product' 0 %}`.replace('0', '{{ product.id }}');
}

function initializeStarRating() {
  const stars = document.querySelectorAll("#rating-stars i");
  const ratingValue = document.getElementById("rating-value");

  if (stars.length > 0 && ratingValue) {
    stars.forEach(function (star, index) {
      star.addEventListener("click", function () {
        const rating = this.getAttribute("data-rating");
        ratingValue.value = rating;

        stars.forEach(function (s, i) {
          if (i < rating) {
            s.classList.add("active");
            s.style.color = "#ffc107";
          } else {
            s.classList.remove("active");
            s.style.color = "#ddd";
          }
        });
      });

      star.addEventListener("mouseover", function () {
        const rating = this.getAttribute("data-rating");
        stars.forEach(function (s, i) {
          if (i < rating) {
            s.style.color = "#ffc107";
          } else {
            s.style.color = "#ddd";
          }
        });
      });
    });

    const ratingContainer = document.getElementById("rating-stars");
    if (ratingContainer) {
      ratingContainer.addEventListener("mouseleave", function () {
        const currentRating = ratingValue.value;
        stars.forEach(function (s, i) {
          if (i < currentRating) {
            s.style.color = "#ffc107";
          } else {
            s.style.color = "#ddd";
          }
        });
      });
    }
  }
}

document.addEventListener('click', function(e) {
    if (e.target.closest('.heart-wishlist-btn')) {
        e.preventDefault();
        const button = e.target.closest('.heart-wishlist-btn');
        
        if (button.href && button.href.includes('login')) {
            return true;
        }
        
        const productId = button.dataset.productId;
        const isInWishlist = button.dataset.inWishlist === 'true';
        
        if (productId) {
            toggleWishlist(productId, button, !isInWishlist);
        }
    }
});

function toggleWishlist(productId, button, addToWishlist) {
    const icon = button.querySelector('i');
    const originalClass = icon.className;
    
    button.classList.add('loading');
    icon.className = 'fa fa-spinner';
    button.disabled = true;
    
    const url = addToWishlist ? 
        `/users/wishlist/add/${productId}/` : 
        `/users/wishlist/remove/${productId}/`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.dataset.inWishlist = addToWishlist ? 'true' : 'false';
            
            if (addToWishlist) {
                icon.className = 'fa fa-heart filled';
                button.title = 'Remove from wishlist';
            } else {
                icon.className = 'fa fa-heart';
                icon.classList.remove('filled');
                button.title = 'Add to wishlist';
            }
            
            showToast(data.message, 'success');
        } else {
            icon.className = originalClass;
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        icon.className = originalClass;
        showToast('An error occurred', 'error');
    })
    .finally(() => {
        button.classList.remove('loading');
        button.disabled = false;
    });
}

function showToast(message, type) {
    document.querySelectorAll('.toast-notification').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} toast-notification alert-dismissible fade show`;
    toast.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        animation: slideInRight 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    `;
    toast.innerHTML = `
        <i class="fa fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
        <button type="button" class="close" onclick="this.parentElement.remove()">
            <span>&times;</span>
        </button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }
    }, 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener("DOMContentLoaded", function () {
  initializeSellerInitials();
  setColorSwatches();
  updateImages();
  initializeStarRating();

  const variationForm = document.getElementById("variation-form");
  if (variationForm) {
    const allInputs = variationForm.querySelectorAll("input, select");
    allInputs.forEach(function (input) {
      input.addEventListener("change", updateVariation);
    });
    
    updateCartForm();
    updateAvailableOptions();
    updateStockStatus();
  }

  const cartForm = document.getElementById('add-to-cart-form');
  if (cartForm) {
    cartForm.addEventListener('submit', function(e) {
      if (!validateCartForm()) {
        e.preventDefault();
        return false;
      }
      
      updateCartForm();
    });
  }
});
</script>

{% endblock %}