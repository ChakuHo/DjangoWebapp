{% extends "master/base.html" %} 
{% load static %} 
{% block content %}

<section class="section-conten padding-y bg">
  <div class="container">
    <div class="row">
      {% include 'users/includes/sidebar.html' %}

      <main class="col-md-9">
        <article class="card shadow-sm">
          <header class="card-header bg-light">
            <strong class="d-inline-block mr-3">
              <i class="fa fa-shield-alt mr-2 text-primary"></i>Change Your Password
            </strong>
            <small class="text-muted ml-2">Keep your account secure</small>
          </header>
          <div class="card-body">
            
            <!-- Messages Display -->
            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                  <i class="fa fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %} mr-2"></i>
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% endfor %}
            {% endif %}
            
            {% if error %}
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fa fa-exclamation-triangle mr-2"></i>
                {{ error }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
            {% endif %}

            <div class="row">
              <div class="col-md-8 mx-auto">
                
                <!-- Security Tips -->
                <div class="alert alert-info border-left-primary mb-4">
                  <div class="row align-items-center">
                    <div class="col-auto">
                      <i class="fa fa-lightbulb fa-2x text-primary"></i>
                    </div>
                    <div class="col">
                      <h6 class="mb-1">Password Security Tips</h6>
                      <small class="text-muted">
                        Use a mix of letters, numbers, and symbols. Avoid common words or personal information.
                      </small>
                    </div>
                  </div>
                </div>

                <form action="{% url 'change_password' %}" method="POST" id="password-form" novalidate>
                  {% csrf_token %} 
                  
                  <!-- Current Password -->
                  <div class="form-group mb-4">
                    <label for="current_password" class="form-label font-weight-bold">
                      <i class="fa fa-lock mr-2 text-secondary"></i>Current Password
                    </label>
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fa fa-key"></i></span>
                      </div>
                      <input
                        type="password"
                        name="current_password"
                        id="current_password"
                        placeholder="Enter your current password"
                        class="form-control"
                        required
                        autocomplete="current-password"
                      />
                      <div class="input-group-append">
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="current_password">
                          <i class="fa fa-eye"></i>
                        </button>
                      </div>
                      <div class="invalid-feedback"></div>
                      <div class="valid-feedback">Current password verified!</div>
                    </div>
                  </div>
                  
                  <!-- New Password -->
                  <div class="form-group mb-4">
                    <label for="new_password" class="form-label font-weight-bold">
                      <i class="fa fa-plus-circle mr-2 text-success"></i>New Password
                    </label>
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fa fa-shield-alt"></i></span>
                      </div>
                      <input
                        type="password"
                        name="new_password"
                        id="new_password"
                        placeholder="Create a strong new password"
                        class="form-control"
                        required
                        minlength="8"
                        autocomplete="new-password"
                      />
                      <div class="input-group-append">
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="new_password">
                          <i class="fa fa-eye"></i>
                        </button>
                      </div>
                      <div class="invalid-feedback"></div>
                      <div class="valid-feedback">Strong password!</div>
                    </div>
                    
                    <!-- Password Strength Meter -->
                    <div class="password-strength-meter mt-2" style="display: none;">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Password Strength:</small>
                        <small class="strength-text text-muted">Weak</small>
                      </div>
                      <div class="progress" style="height: 6px;">
                        <div class="progress-bar strength-bar" role="progressbar" style="width: 0%"></div>
                      </div>
                    </div>
                    
                    <!-- Password Requirements -->
                    <div class="password-requirements mt-3" style="display: none;">
                      <small class="text-muted d-block mb-2">Password must contain:</small>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="requirement" data-requirement="length">
                            <i class="fa fa-times text-danger"></i>
                            <small>At least 8 characters</small>
                          </div>
                          <div class="requirement" data-requirement="uppercase">
                            <i class="fa fa-times text-danger"></i>
                            <small>One uppercase letter</small>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="requirement" data-requirement="lowercase">
                            <i class="fa fa-times text-danger"></i>
                            <small>One lowercase letter</small>
                          </div>
                          <div class="requirement" data-requirement="number">
                            <i class="fa fa-times text-danger"></i>
                            <small>One number</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Confirm Password -->
                  <div class="form-group mb-4">
                    <label for="confirm_password" class="form-label font-weight-bold">
                      <i class="fa fa-check-double mr-2 text-info"></i>Confirm New Password
                    </label>
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fa fa-check"></i></span>
                      </div>
                      <input
                        type="password"
                        name="confirm_password"
                        id="confirm_password"
                        placeholder="Confirm your new password"
                        class="form-control"
                        required
                        autocomplete="new-password"
                      />
                      <div class="input-group-append">
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="confirm_password">
                          <i class="fa fa-eye"></i>
                        </button>
                      </div>
                      <div class="invalid-feedback"></div>
                      <div class="valid-feedback">Passwords match!</div>
                    </div>
                    <div class="password-match-indicator mt-2" style="display: none;">
                      <small class="match-text"></small>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="form-group text-center mt-5">
                    <button type="submit" class="btn btn-success btn-lg px-5 mr-3" id="submit-btn">
                      <i class="fa fa-shield-alt mr-2"></i>Update Password
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-lg px-4">
                      <i class="fa fa-arrow-left mr-2"></i>Cancel
                    </a>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </article>
      </main>
    </div>
  </div>
</section>

<!-- Enhanced Styling -->
<style>
.border-left-primary {
  border-left: 4px solid #007bff !important;
}

.form-label {
  color: #495057;
  margin-bottom: 8px;
}

.input-group-text {
  background-color: #f8f9fa;
  border-color: #ced4da;
  color: #6c757d;
}

.form-control:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.toggle-password {
  border-left: none;
}

.toggle-password:focus {
  box-shadow: none;
}

.password-strength-meter .progress {
  background-color: #e9ecef;
  border-radius: 10px;
}

.strength-bar {
  border-radius: 10px;
  transition: all 0.3s ease;
}

.strength-weak { background-color: #dc3545; }
.strength-fair { background-color: #fd7e14; }
.strength-good { background-color: #ffc107; }
.strength-strong { background-color: #28a745; }

.requirement {
  display: flex;
  align-items: center;
  margin-bottom: 4px;
}

.requirement i {
  width: 16px;
  margin-right: 8px;
  font-size: 12px;
}

.requirement.valid i {
  color: #28a745 !important;
}

.btn-success {
  background: linear-gradient(45deg, #28a745, #20c997);
  border: none;
  transition: all 0.3s ease;
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
}

.card {
  border: none;
  border-radius: 15px;
}

.card-header {
  border-radius: 15px 15px 0 0 !important;
}

.password-match-indicator .text-success {
  color: #28a745 !important;
}

.password-match-indicator .text-danger {
  color: #dc3545 !important;
}
</style>

<!-- Enhanced Password Validation Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('password-form');
    const currentPassword = document.getElementById('current_password');
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const submitBtn = document.getElementById('submit-btn');
    
    // Password visibility toggle
    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const targetInput = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (targetInput.type === 'password') {
                targetInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                this.setAttribute('title', 'Hide password');
            } else {
                targetInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                this.setAttribute('title', 'Show password');
            }
        });
    });
    
    // Current password validation
    currentPassword.addEventListener('input', function() {
        this.classList.remove('is-valid', 'is-invalid');
        
        if (this.value.length === 0) {
            this.setCustomValidity('Current password is required');
            this.classList.add('is-invalid');
            const feedback = this.parentNode.querySelector('.invalid-feedback');
            if (feedback) feedback.textContent = 'Current password is required';
        } else {
            this.setCustomValidity('');
            this.classList.add('is-valid');
        }
        updateSubmitButton();
    });
    
    // New password validation with strength meter
    newPassword.addEventListener('input', function() {
        const password = this.value;
        
        // Show requirements and strength meter
        document.querySelector('.password-requirements').style.display = 'block';
        document.querySelector('.password-strength-meter').style.display = 'block';
        
        // Check requirements
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password)
        };
        
        // Update requirement indicators
        Object.keys(requirements).forEach(req => {
            const element = document.querySelector(`[data-requirement="${req}"]`);
            const icon = element.querySelector('i');
            
            if (requirements[req]) {
                element.classList.add('valid');
                icon.classList.remove('fa-times', 'text-danger');
                icon.classList.add('fa-check', 'text-success');
            } else {
                element.classList.remove('valid');
                icon.classList.remove('fa-check', 'text-success');
                icon.classList.add('fa-times', 'text-danger');
            }
        });
        
        // Calculate strength
        let strength = 0;
        let strengthText = 'Very Weak';
        let strengthClass = 'strength-weak';
        
        if (requirements.length) strength += 25;
        if (requirements.uppercase) strength += 25;
        if (requirements.lowercase) strength += 25;
        if (requirements.number) strength += 25;
        
        // Bonus points for special characters and length
        if (/[!@#$%^&*()_+\-=```math
```{};':"\\|,.<>\/?]/.test(password)) strength += 10;
        if (password.length >= 12) strength += 10;
        
        // Determine strength level
        if (strength >= 90) {
            strengthText = 'Very Strong';
            strengthClass = 'strength-strong';
        } else if (strength >= 70) {
            strengthText = 'Strong';
            strengthClass = 'strength-strong';
        } else if (strength >= 50) {
            strengthText = 'Good';
            strengthClass = 'strength-good';
        } else if (strength >= 30) {
            strengthText = 'Fair';
            strengthClass = 'strength-fair';
        }
        
        // Update strength meter
        const strengthBar = document.querySelector('.strength-bar');
        const strengthTextEl = document.querySelector('.strength-text');
        
        strengthBar.style.width = Math.min(strength, 100) + '%';
        strengthBar.className = `progress-bar ${strengthClass}`;
        strengthTextEl.textContent = strengthText;
        strengthTextEl.className = `strength-text ${strengthClass === 'strength-strong' ? 'text-success' : strengthClass === 'strength-good' ? 'text-warning' : 'text-danger'}`;
        
        // Validate password
        this.classList.remove('is-valid', 'is-invalid');
        
        if (password.length === 0) {
            this.setCustomValidity('New password is required');
            this.classList.add('is-invalid');
            const feedback = this.parentNode.querySelector('.invalid-feedback');
            if (feedback) feedback.textContent = 'New password is required';
        } else if (!requirements.length) {
            this.setCustomValidity('Password must be at least 8 characters long');
            this.classList.add('is-invalid');
            const feedback = this.parentNode.querySelector('.invalid-feedback');
            if (feedback) feedback.textContent = 'Password must be at least 8 characters long';
        } else if (!requirements.uppercase || !requirements.lowercase || !requirements.number) {
            this.setCustomValidity('Password must contain uppercase, lowercase, and number');
            this.classList.add('is-invalid');
            const feedback = this.parentNode.querySelector('.invalid-feedback');
            if (feedback) feedback.textContent = 'Password must contain uppercase, lowercase, and number';
        } else {
            this.setCustomValidity('');
            this.classList.add('is-valid');
        }
        
        // Re-validate confirm password
        if (confirmPassword.value) {
            validatePasswordMatch();
        }
        
        updateSubmitButton();
    });
    
    // Confirm password validation
    confirmPassword.addEventListener('input', validatePasswordMatch);
    
    function validatePasswordMatch() {
        const password = newPassword.value;
        const confirm = confirmPassword.value;
        const indicator = document.querySelector('.password-match-indicator');
        const matchText = indicator.querySelector('.match-text');
        
        confirmPassword.classList.remove('is-valid', 'is-invalid');
        
        if (confirm.length === 0) {
            confirmPassword.setCustomValidity('Please confirm your password');
            confirmPassword.classList.add('is-invalid');
            const feedback = confirmPassword.parentNode.querySelector('.invalid-feedback');
            if (feedback) feedback.textContent = 'Please confirm your password';
            indicator.style.display = 'none';
        } else if (password !== confirm) {
            confirmPassword.setCustomValidity('Passwords do not match');
            confirmPassword.classList.add('is-invalid');
            const feedback = confirmPassword.parentNode.querySelector('.invalid-feedback');
            if (feedback) feedback.textContent = 'Passwords do not match';
            
            indicator.style.display = 'block';
            matchText.textContent = '✗ Passwords do not match';
            matchText.className = 'match-text text-danger';
        } else {
            confirmPassword.setCustomValidity('');
            confirmPassword.classList.add('is-valid');
            
            indicator.style.display = 'block';
            matchText.textContent = '✓ Passwords match perfectly!';
            matchText.className = 'match-text text-success';
        }
        
        updateSubmitButton();
    }
    
    function updateSubmitButton() {
        const isCurrentValid = currentPassword.checkValidity() && currentPassword.value.length > 0;
        const isNewValid = newPassword.checkValidity() && newPassword.value.length >= 8;
        const isConfirmValid = confirmPassword.checkValidity() && confirmPassword.value === newPassword.value;
        
        if (isCurrentValid && isNewValid && isConfirmValid) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-success');
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-secondary');
        }
    }
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Validate all fields
        [currentPassword, newPassword, confirmPassword].forEach(field => {
            if (!field.checkValidity() || !field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });
        
        // Check if passwords match
        if (newPassword.value !== confirmPassword.value) {
            confirmPassword.classList.add('is-invalid');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            // Scroll to first invalid field
            const firstInvalid = form.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.focus();
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
    
    // Initialize submit button state
    updateSubmitButton();
});
</script>

{% endblock %}