{% extends "master/base.html" %} {% load static %} {% block content %}

<section class="section-conten padding-y bg">
  <div class="container">
    <div class="row">
      {% include 'users/includes/sidebar.html' %}
      
      <main class="col-md-9">
        <!-- Enhanced Header with Quick Actions -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fa fa-store text-primary"></i> My Products</h5>
            <div>
              <a href="{% url 'add_product' %}" class="btn btn-primary">
                <i class="fa fa-plus"></i> Add Product
              </a>
              <button class="btn btn-outline-secondary" onclick="toggleBulkMode()">
                <i class="fa fa-edit"></i> Bulk Edit
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3">
                <h4 class="text-primary">{{ total_products }}</h4>
                <small class="text-muted">Total Products</small>
              </div>
              <div class="col-md-3">
                <h4 class="text-warning">{{ pending_products }}</h4>
                <small class="text-muted">Pending</small>
              </div>
              <div class="col-md-3">
                <h4 class="text-success">{{ approved_products }}</h4>
                <small class="text-muted">Live</small>
              </div>
              <div class="col-md-3">
                <h4 class="text-danger">{{ rejected_products }}</h4>
                <small class="text-muted">Rejected</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter and Search -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <input type="text" class="form-control" id="productSearch" placeholder="üîç Search products...">
              </div>
              <div class="col-md-3">
                <select class="form-control" id="statusFilter">
                  <option value="">All Status</option>
                  <option value="pending">Pending</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-control" id="stockFilter">
                  <option value="">All Stock</option>
                  <option value="low">Low Stock (‚â§5)</option>
                  <option value="out">Out of Stock</option>
                  <option value="good">Good Stock (>5)</option>
                </select>
              </div>
              <div class="col-md-2">
                <button class="btn btn-outline-primary btn-block" onclick="clearFilters()">
                  <i class="fa fa-times"></i> Clear
                </button>
              </div>
            </div>
          </div>
        </div>

        {% if products %}
          <!-- Bulk Actions (Hidden by default) -->
          <div class="card mb-3" id="bulkActions" style="display: none;">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <div class="form-check form-check-inline">
                    <input type="checkbox" class="form-check-input" id="selectAll">
                    <label class="form-check-label" for="selectAll">Select All</label>
                  </div>
                  <span id="selectedCount" class="text-muted ml-3">0 selected</span>
                </div>
                <div class="col-md-4">
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-warning" onclick="bulkUpdateStock()">
                      <i class="fa fa-box"></i> Update Stock
                    </button>
                    <button class="btn btn-danger" onclick="bulkDelete()">
                      <i class="fa fa-trash"></i> Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {% for product in products %}
          <div class="card mb-3 product-item" 
               data-status="{{ product.approval_status }}" 
               data-stock="{{ product.stock }}"
               data-name="{{ product.name|lower }}">
            <div class="card-body">
              <div class="row align-items-center">
                <!-- Bulk Select Checkbox -->
                <div class="col-md-1 bulk-select" style="display: none;">
                  <input type="checkbox" class="form-check-input product-checkbox" value="{{ product.id }}">
                </div>
                
                <!-- Product Image -->
                <div class="col-md-2">
                  {% if product.image %}
                    <img src="{{ product.image.url }}" class="img-thumbnail" 
                         style="width: 80px; height: 80px; object-fit: cover;">
                  {% else %}
                    <img src="https://via.placeholder.com/80x80?text=No+Image" class="img-thumbnail">
                  {% endif %}
                </div>
                
                <!-- Product Info (Editable) -->
                <div class="col-md-4">
                  <!-- Product Name -->
                  <h6 class="mb-1">
                    <span class="editable-field" data-field="name" data-product="{{ product.id }}">
                      {{ product.name }}
                    </span>
                    <i class="fa fa-edit text-muted edit-icon" style="cursor: pointer; display: none;"></i>
                  </h6>
                  
                  <!-- Description -->
                  <p class="text-muted small mb-1">
                    <span class="editable-field" data-field="description" data-product="{{ product.id }}">
                      {{ product.description|truncatewords:10 }}
                    </span>
                  </p>
                  
                  <!-- Price (Editable) -->
                  <span class="text-primary font-weight-bold">
                    Rs. <span class="editable-field" data-field="price" data-product="{{ product.id }}">
                      {{ product.price }}
                    </span>
                  </span>
                </div>
                
                <!-- Stock (Editable with Quick Controls) -->
                <div class="col-md-2">
                  <small class="text-muted">Stock</small><br>
                  <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                      <button class="btn btn-outline-secondary" type="button" 
                              onclick="adjustStock({{ product.id }}, -1)">-</button>
                    </div>
                    <input type="number" class="form-control text-center stock-input" 
                           value="{{ product.stock }}" 
                           data-product="{{ product.id }}"
                           onchange="updateStock({{ product.id }}, this.value)">
                    <div class="input-group-append">
                      <button class="btn btn-outline-secondary" type="button" 
                              onclick="adjustStock({{ product.id }}, 1)">+</button>
                    </div>
                  </div>
                  
                  <!-- Stock Status Indicator -->
                  {% if product.stock == 0 %}
                    <small class="text-danger">Out of Stock</small>
                  {% elif product.stock <= 5 %}
                    <small class="text-warning">Low Stock</small>
                  {% else %}
                    <small class="text-success">In Stock</small>
                  {% endif %}
                </div>
                
                <!-- Status -->
                <div class="col-md-2">
                  <small class="text-muted">Status</small><br>
                  {% if product.approval_status == 'pending' %}
                    <span class="badge badge-warning">‚è≥ Pending</span>
                  {% elif product.approval_status == 'approved' %}
                    <span class="badge badge-success">‚úÖ Approved</span>
                  {% elif product.approval_status == 'rejected' %}
                    <span class="badge badge-danger">‚ùå Rejected</span>
                  {% endif %}
                  
                  <!-- Live Status Toggle for Approved Products -->
                  {% if product.approval_status == 'approved' %}
                    <br><small class="text-muted">Visibility</small><br>
                    <div class="custom-control custom-switch">
                      <input type="checkbox" class="custom-control-input" 
                             id="status{{ product.id }}" 
                             {% if product.status %}checked{% endif %}
                             onchange="toggleProductStatus({{ product.id }})">
                      <label class="custom-control-label" for="status{{ product.id }}">
                        <small>{% if product.status %}Live{% else %}Hidden{% endif %}</small>
                      </label>
                    </div>
                  {% endif %}
                </div>
                
                <!-- Actions -->
                <div class="col-md-1">
                  <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                            type="button" data-toggle="dropdown">
                      <i class="fa fa-ellipsis-v"></i>
                    </button>
                    <div class="dropdown-menu">
                      <a class="dropdown-item" href="{{ product.get_url }}" target="_blank">
                        <i class="fa fa-eye"></i> View Product
                      </a>
                      <button class="dropdown-item" onclick="editProductModal({{ product.id }})">
                        <i class="fa fa-edit"></i> Full Edit
                      </button>
                      <button class="dropdown-item" onclick="duplicateProduct({{ product.id }})">
                        <i class="fa fa-copy"></i> Duplicate
                      </button>
                      <div class="dropdown-divider"></div>
                      {% if product.approval_status == 'rejected' %}
                        <button class="dropdown-item text-info" onclick="showRejectionReason({{ product.id }})">
                          <i class="fa fa-info-circle"></i> Why Rejected?
                        </button>
                      {% endif %}
                      <button class="dropdown-item text-danger" onclick="deleteProduct({{ product.id }})">
                        <i class="fa fa-trash"></i> Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Rejection Reason (if rejected) -->
              {% if product.approval_status == 'rejected' and product.rejection_reason %}
                <div class="row mt-2">
                  <div class="col-12">
                    <div class="alert alert-danger">
                      <strong>Rejection Reason:</strong> {{ product.rejection_reason }}
                    </div>
                  </div>
                </div>
              {% endif %}
              
              <!-- Sales Analytics (if approved) -->
              {% if product.approval_status == 'approved' %}
                <div class="row mt-2">
                  <div class="col-12">
                    <small class="text-muted">
                      <i class="fa fa-chart-line"></i> 
                      Views: {{ product.views|default:0 }} | 
                      Orders: {{ product.orders_count|default:0 }} | 
                      Revenue: Rs. {{ product.total_revenue|default:0 }}
                    </small>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="card">
            <div class="card-body text-center py-5">
              <i class="fa fa-box-open fa-4x text-muted mb-3"></i>
              <h5>No Products Yet</h5>
              <p class="text-muted">You haven't added any products to sell yet.</p>
              <a href="{% url 'add_product' %}" class="btn btn-primary">
                <i class="fa fa-plus"></i> Add Your First Product
              </a>
            </div>
          </div>
        {% endif %}
      </main>
    </div>
  </div>
</section>

<!-- Quick Edit Modal -->
<div class="modal fade" id="quickEditModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Edit Product</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body" id="quickEditContent">
        <!-- Content loaded via AJAX -->
      </div>
    </div>
  </div>
</div>

<!-- Bulk Stock Update Modal -->
<div class="modal fade" id="bulkStockModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update Stock for Selected Products</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Action</label>
          <select class="form-control" id="stockAction">
            <option value="set">Set stock to specific amount</option>
            <option value="add">Add to current stock</option>
            <option value="subtract">Subtract from current stock</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input type="number" class="form-control" id="stockAmount" min="0">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="confirmBulkStock()">Update Stock</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let editMode = false;
    let selectedProducts = new Set();
    
    // Search functionality
    document.getElementById('productSearch').addEventListener('input', filterProducts);
    document.getElementById('statusFilter').addEventListener('change', filterProducts);
    document.getElementById('stockFilter').addEventListener('change', filterProducts);
    
    // Bulk mode toggle
    window.toggleBulkMode = function() {
        editMode = !editMode;
        const bulkSelects = document.querySelectorAll('.bulk-select');
        const bulkActions = document.getElementById('bulkActions');
        const editIcons = document.querySelectorAll('.edit-icon');
        
        if (editMode) {
            bulkSelects.forEach(el => el.style.display = 'block');
            bulkActions.style.display = 'block';
            editIcons.forEach(el => el.style.display = 'inline');
        } else {
            bulkSelects.forEach(el => el.style.display = 'none');
            bulkActions.style.display = 'none';
            editIcons.forEach(el => el.style.display = 'none');
            selectedProducts.clear();
            updateSelectedCount();
        }
    };
    
    // Product selection
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-checkbox')) {
            const productId = e.target.value;
            if (e.target.checked) {
                selectedProducts.add(productId);
            } else {
                selectedProducts.delete(productId);
            }
            updateSelectedCount();
        }
        
        if (e.target.id === 'selectAll') {
            const checkboxes = document.querySelectorAll('.product-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = e.target.checked;
                if (e.target.checked) {
                    selectedProducts.add(cb.value);
                } else {
                    selectedProducts.delete(cb.value);
                }
            });
            updateSelectedCount();
        }
    });
    
    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = `${selectedProducts.size} selected`;
    }
    
    function filterProducts() {
        const search = document.getElementById('productSearch').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const stock = document.getElementById('stockFilter').value;
        
        document.querySelectorAll('.product-item').forEach(item => {
            const name = item.dataset.name;
            const itemStatus = item.dataset.status;
            const itemStock = parseInt(item.dataset.stock);
            
            let show = true;
            
            if (search && !name.includes(search)) show = false;
            if (status && itemStatus !== status) show = false;
            if (stock) {
                if (stock === 'low' && itemStock > 5) show = false;
                if (stock === 'out' && itemStock > 0) show = false;
                if (stock === 'good' && itemStock <= 5) show = false;
            }
            
            item.style.display = show ? 'block' : 'none';
        });
    }
    
    window.clearFilters = function() {
        document.getElementById('productSearch').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('stockFilter').value = '';
        filterProducts();
    };
    
    // Stock adjustment
    window.adjustStock = function(productId, change) {
        const input = document.querySelector(`input[data-product="${productId}"]`);
        const newValue = Math.max(0, parseInt(input.value) + change);
        input.value = newValue;
        updateStock(productId, newValue);
    };
    
    window.updateStock = function(productId, newStock) {
        fetch(`/accounts/update-product-stock/${productId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({stock: newStock})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update stock indicator
                const item = document.querySelector(`[data-product="${productId}"]`).closest('.product-item');
                item.dataset.stock = newStock;
                
                // Show success feedback
                showToast('Stock updated successfully', 'success');
            } else {
                showToast('Error updating stock', 'error');
            }
        });
    };
    
    window.toggleProductStatus = function(productId) {
        const checkbox = document.getElementById(`status${productId}`);
        const isLive = checkbox.checked;
        
        fetch(`/accounts/toggle-product-status/${productId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({status: isLive})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const label = checkbox.nextElementSibling.querySelector('small');
                label.textContent = isLive ? 'Live' : 'Hidden';
                showToast(`Product ${isLive ? 'made live' : 'hidden'}`, 'success');
            } else {
                checkbox.checked = !isLive; // Revert on error
                showToast('Error updating product status', 'error');
            }
        });
    };
    
    window.deleteProduct = function(productId) {
        if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
            fetch(`/accounts/delete-product/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`[data-product="${productId}"]`).closest('.product-item').remove();
                    showToast('Product deleted successfully', 'success');
                } else {
                    showToast('Error deleting product', 'error');
                }
            });
        }
    };
    
    window.duplicateProduct = function(productId) {
        if (confirm('Create a copy of this product?')) {
            fetch(`/accounts/duplicate-product/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Product duplicated successfully', 'success');
                    location.reload();
                } else {
                    showToast('Error duplicating product', 'error');
                }
            });
        }
    };
    
    window.editProductModal = function(productId) {
        // Load full edit form in modal
        $('#quickEditModal').modal('show');
        document.getElementById('quickEditContent').innerHTML = '<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading...</div>';
        
        fetch(`/accounts/edit-product/${productId}/`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('quickEditContent').innerHTML = html;
            });
    };
    
    window.bulkUpdateStock = function() {
        if (selectedProducts.size === 0) {
            alert('Please select products first');
            return;
        }
        $('#bulkStockModal').modal('show');
    };
    
    window.confirmBulkStock = function() {
        const action = document.getElementById('stockAction').value;
        const amount = parseInt(document.getElementById('stockAmount').value);
        
        if (!amount && amount !== 0) {
            alert('Please enter a valid amount');
            return;
        }
        
        fetch('/accounts/bulk-update-stock/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                products: Array.from(selectedProducts),
                action: action,
                amount: amount
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#bulkStockModal').modal('hide');
                location.reload();
                showToast(`Stock updated for ${data.updated_count} products`, 'success');
            } else {
                showToast('Error updating stock', 'error');
            }
        });
    };
    
    window.bulkDelete = function() {
        if (selectedProducts.size === 0) {
            alert('Please select products first');
            return;
        }
        
        if (confirm(`Are you sure you want to delete ${selectedProducts.size} selected products?`)) {
            fetch('/accounts/bulk-delete-products/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    products: Array.from(selectedProducts)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                    showToast(`${data.deleted_count} products deleted`, 'success');
                } else {
                    showToast('Error deleting products', 'error');
                }
            });
        }
    };
    
    function showToast(message, type) {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} toast-notification`;
        toast.style.position = 'fixed';
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.zIndex = '9999';
        toast.innerHTML = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
});
</script>

<style>
.editable-field:hover {
    background-color: #f8f9fa;
    border-radius: 3px;
    padding: 2px 4px;
    cursor: text;
}

.custom-control-label small {
    font-size: 0.8em;
}

.toast-notification {
    animation: slideIn 0.3s ease-in-out;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
</style>

{% endblock %}