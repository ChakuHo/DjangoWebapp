{% extends "master/base.html" %} {% load static %} {% block content %}

<section class="section-conten padding-y bg">
  <div class="container">
    <div class="row">
      {% include 'users/includes/sidebar.html' %}
      
      <main class="col-md-9">
        <!-- Enhanced Header with Quick Actions -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fa fa-store text-primary"></i> My Products</h5>
            <div>
              <a href="{% url 'add_product' %}" class="btn btn-primary">
                <i class="fa fa-plus"></i> Add Product
              </a>
              <button class="btn btn-outline-secondary" onclick="toggleBulkMode()">
                <i class="fa fa-edit"></i> Bulk Edit
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3">
                <h4 class="text-primary">{{ total_products }}</h4>
                <small class="text-muted">Total Products</small>
              </div>
              <div class="col-md-3">
                <h4 class="text-warning">{{ pending_products }}</h4>
                <small class="text-muted">Pending</small>
              </div>
              <div class="col-md-3">
                <h4 class="text-success">{{ approved_products }}</h4>
                <small class="text-muted">Live</small>
              </div>
              <div class="col-md-3">
                <h4 class="text-danger">{{ rejected_products }}</h4>
                <small class="text-muted">Rejected</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Permission Info Alert -->
        <div class="alert alert-info">
          <i class="fa fa-info-circle"></i>
          <strong>Editing Permissions:</strong> You can only edit (stock, visibility, etc.) products that have been approved by admin. 
          Pending and rejected products cannot be modified until approval.
        </div>

        <!-- Filter and Search -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <input type="text" class="form-control" id="productSearch" placeholder="üîç Search products...">
              </div>
              <div class="col-md-3">
                <select class="form-control" id="statusFilter">
                  <option value="">All Status</option>
                  <option value="pending">Pending</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-control" id="stockFilter">
                  <option value="">All Stock</option>
                  <option value="low">Low Stock (‚â§5)</option>
                  <option value="out">Out of Stock</option>
                  <option value="good">Good Stock (>5)</option>
                </select>
              </div>
              <div class="col-md-2">
                <button class="btn btn-outline-primary btn-block" onclick="clearFilters()">
                  <i class="fa fa-times"></i> Clear
                </button>
              </div>
            </div>
          </div>
        </div>

        {% if products %}
          <!-- Bulk Actions (Hidden by default) - Only for approved products -->
          <div class="card mb-3" id="bulkActions" style="display: none;">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-8">
                  <div class="form-check form-check-inline">
                    <input type="checkbox" class="form-check-input" id="selectAll">
                    <label class="form-check-label" for="selectAll">Select All Approved</label>
                  </div>
                  <span id="selectedCount" class="text-muted ml-3">0 selected</span>
                </div>
                <div class="col-md-4">
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-warning" onclick="bulkUpdateStock()">
                      <i class="fa fa-box"></i> Update Stock
                    </button>
                    <button class="btn btn-info" onclick="bulkToggleVisibility()">
                      <i class="fa fa-eye"></i> Toggle Visibility
                    </button>
                    <button class="btn btn-danger" onclick="bulkDelete()">
                      <i class="fa fa-trash"></i> Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {% for product in products %}
          <div class="card mb-3 product-item {% if product.approval_status != 'approved' %}product-locked{% endif %}" 
               data-status="{{ product.approval_status }}" 
               data-stock="{{ product.stock }}"
               data-name="{{ product.name|lower }}">
            <div class="card-body">
              <div class="row align-items-center">
                <!-- Bulk Select Checkbox - Only for approved products -->
                <div class="col-md-1 bulk-select" style="display: none;">
                <!-- Sales Analytics (only for approved products) -->
                {% if product.approval_status == 'approved' %}
                  <div class="row mt-2">
                    <div class="col-12">
                      <small class="text-muted">
                        <i class="fa fa-chart-line"></i> 
                        Views: <span class="badge badge-info">{{ product.view_count|default:0 }}</span> | 
                        Orders: <span class="badge badge-success">{{ product.order_count|default:0 }}</span> | 
                        Revenue: <span class="badge badge-primary">Rs. {{ product.total_revenue|default:0|floatformat:2 }}</span>
                        
                        <!-- Add conversion rate if there are views -->
                        {% if product.view_count > 0 %}
                          | Conversion: <span class="badge badge-warning">{{ product.analytics.conversion_rate|floatformat:1 }}%</span>
                        {% endif %}
                      </small>
                    </div>
                  </div>
                {% endif %}
                </div>
                
                <!-- Product Image -->
                <div class="col-md-2">
                  {% if product.image %}
                    <img src="{{ product.image.url }}" class="img-thumbnail" 
                         style="width: 80px; height: 80px; object-fit: cover;">
                  {% else %}
                    <img src="https://via.placeholder.com/80x80?text=No+Image" class="img-thumbnail">
                  {% endif %}
                  
                  <!-- Permission Lock Indicator -->
                  {% if product.approval_status != 'approved' %}
                    <div class="text-center mt-1">
                      <i class="fa fa-lock text-muted" title="Cannot edit until approved"></i>
                    </div>
                  {% endif %}
                </div>
                
                <!-- Product Info -->
                <div class="col-md-4">
                  <!-- Product Name -->
                  <h6 class="mb-1">
                    <span class="editable-field {% if product.approval_status != 'approved' %}text-muted{% endif %}" 
                          data-field="name" data-product="{{ product.id }}"
                          {% if product.approval_status == 'approved' %}data-editable="true"{% endif %}>
                      {{ product.name }}
                    </span>
                    {% if product.approval_status == 'approved' %}
                      <i class="fa fa-edit text-muted edit-icon" style="cursor: pointer; display: none;"></i>
                    {% endif %}
                  </h6>
                  
                  <!-- Description -->
                  <p class="text-muted small mb-1">
                    <span class="editable-field" data-field="description" data-product="{{ product.id }}"
                          {% if product.approval_status == 'approved' %}data-editable="true"{% endif %}>
                      {{ product.description|truncatewords:10 }}
                    </span>
                  </p>
                  
                  <!-- Price -->
                  <span class="text-primary font-weight-bold">
                    Rs. <span class="editable-field" data-field="price" data-product="{{ product.id }}"
                              {% if product.approval_status == 'approved' %}data-editable="true"{% endif %}>
                      {{ product.price }}
                    </span>
                  </span>
                </div>
                
                <!-- Stock Management - Enhanced with permissions -->
                <div class="col-md-2">
                  <small class="text-muted">Stock</small><br>
                  {% if product.approval_status == 'approved' %}
                    <!-- Editable stock controls for approved products -->
                    <div class="input-group input-group-sm">
                      <div class="input-group-prepend">
                        <button class="btn btn-outline-secondary" type="button" 
                                onclick="adjustStock({{ product.id }}, -1)"
                                {% if product.stock == 0 %}disabled{% endif %}>-</button>
                      </div>
                      <input type="number" class="form-control text-center stock-input" 
                             value="{{ product.stock }}" 
                             data-product="{{ product.id }}"
                             min="0"
                             onchange="updateStock({{ product.id }}, this.value)">
                      <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" 
                                onclick="adjustStock({{ product.id }}, 1)">+</button>
                      </div>
                    </div>
                    
                    <!-- Quick stock update buttons -->
                    {% if product.stock == 0 %}
                      <div class="mt-2">
                        <button class="btn btn-sm btn-success btn-block" 
                                onclick="quickStockUpdate({{ product.id }}, 10)">
                          <i class="fa fa-plus"></i> Add 10 Stock
                        </button>
                      </div>
                    {% endif %}
                  {% else %}
                    <!-- Read-only stock display for non-approved products -->
                    <div class="text-center">
                      <span class="badge badge-secondary">{{ product.stock }}</span>
                      <br><small class="text-muted">Read Only</small>
                    </div>
                  {% endif %}
                  
                  <!-- Stock Status Indicator -->
                  {% if product.stock == 0 %}
                    <small class="text-danger"><i class="fa fa-exclamation-triangle"></i> Out of Stock</small>
                  {% elif product.stock <= 5 %}
                    <small class="text-warning"><i class="fa fa-exclamation-circle"></i> Low Stock</small>
                  {% else %}
                    <small class="text-success"><i class="fa fa-check-circle"></i> In Stock</small>
                  {% endif %}
                </div>
                
                <!-- Status and Visibility -->
                <div class="col-md-2">
                  <small class="text-muted">Status</small><br>
                  {% if product.approval_status == 'pending' %}
                    <span class="badge badge-warning">‚è≥ Pending Review</span>
                  {% elif product.approval_status == 'approved' %}
                    <span class="badge badge-success">‚úÖ Approved</span>
                  {% elif product.approval_status == 'rejected' %}
                    <span class="badge badge-danger">‚ùå Rejected</span>
                  {% endif %}
                  
                  <!-- Visibility Toggle - Only for approved products -->
                  {% if product.approval_status == 'approved' %}
                    <br><small class="text-muted">Visibility</small><br>
                    <div class="custom-control custom-switch">
                      <input type="checkbox" class="custom-control-input" 
                             id="status{{ product.id }}" 
                             {% if product.status %}checked{% endif %}
                             onchange="toggleProductStatus({{ product.id }})">
                      <label class="custom-control-label" for="status{{ product.id }}">
                        <small class="visibility-label">{% if product.status %}üü¢ Live{% else %}üî¥ Hidden{% endif %}</small>
                      </label>
                    </div>
                  {% else %}
                    <br><small class="text-muted">Visibility: N/A</small>
                  {% endif %}
                </div>
                
                <!-- Actions -->
                <div class="col-md-1">
                  <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                            type="button" data-toggle="dropdown">
                      <i class="fa fa-ellipsis-v"></i>
                    </button>
                    <div class="dropdown-menu">
                      <a class="dropdown-item" href="{{ product.get_url }}" target="_blank">
                        <i class="fa fa-eye"></i> View Product
                      </a>
                      
                      {% if product.approval_status == 'approved' %}
                        <button class="dropdown-item" onclick="editProductModal({{ product.id }})">
                          <i class="fa fa-edit"></i> Edit Details
                        </button>
                        <button class="dropdown-item" onclick="duplicateProduct({{ product.id }})">
                          <i class="fa fa-copy"></i> Duplicate
                        </button>
                        <div class="dropdown-divider"></div>
                      {% else %}
                        <button class="dropdown-item text-muted" disabled>
                          <i class="fa fa-lock"></i> Edit (Approval Required)
                        </button>
                      {% endif %}
                      
                      {% if product.approval_status == 'rejected' %}
                        <button class="dropdown-item text-info" onclick="showRejectionReason('{{ product.rejection_reason|default:"No reason provided" }}')">
                          <i class="fa fa-info-circle"></i> Why Rejected?
                        </button>
                        <div class="dropdown-divider"></div>
                      {% endif %}
                      
                      <!-- Delete is always available -->
                      <button class="dropdown-item text-danger" onclick="deleteProduct({{ product.id }})">
                        <i class="fa fa-trash"></i> Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Rejection Reason (if rejected) -->
              {% if product.approval_status == 'rejected' and product.rejection_reason %}
                <div class="row mt-2">
                  <div class="col-12">
                    <div class="alert alert-danger">
                      <strong><i class="fa fa-exclamation-triangle"></i> Rejection Reason:</strong> {{ product.rejection_reason }}
                      <br><small class="text-muted">Please fix the issues and contact admin for re-review.</small>
                    </div>
                  </div>
                </div>
              {% endif %}
              
              <!-- Sales Analytics (only for approved products) -->
              {% if product.approval_status == 'approved' %}
                <div class="row mt-2">
                  <div class="col-12">
                    <small class="text-muted">
                      <i class="fa fa-chart-line"></i> 
                      Views: <span class="badge badge-light">{{ product.views|default:0 }}</span> | 
                      Orders: <span class="badge badge-light">{{ product.orders_count|default:0 }}</span> | 
                      Revenue: <span class="badge badge-light">Rs. {{ product.total_revenue|default:0 }}</span>
                    </small>
                  </div>
                </div>
              {% endif %}
              
              <!-- Permission reminder for non-approved products -->
              {% if product.approval_status != 'approved' %}
                <div class="row mt-2">
                  <div class="col-12">
                    <small class="text-muted">
                      <i class="fa fa-lock"></i> 
                      {% if product.approval_status == 'pending' %}
                        This product is under review. You'll be able to manage stock and visibility once it's approved.
                      {% elif product.approval_status == 'rejected' %}
                        This product was rejected. Please address the issues and contact admin for re-review.
                      {% endif %}
                    </small>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="card">
            <div class="card-body text-center py-5">
              <i class="fa fa-box-open fa-4x text-muted mb-3"></i>
              <h5>No Products Yet</h5>
              <p class="text-muted">You haven't added any products to sell yet.</p>
              <a href="{% url 'add_product' %}" class="btn btn-primary">
                <i class="fa fa-plus"></i> Add Your First Product
              </a>
            </div>
          </div>
        {% endif %}
      </main>
    </div>
  </div>
</section>

<!-- Quick Edit Modal -->
<div class="modal fade" id="quickEditModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Edit Product</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body" id="quickEditContent">
        <!-- Content loaded via AJAX -->
      </div>
    </div>
  </div>
</div>

<!-- Bulk Stock Update Modal -->
<div class="modal fade" id="bulkStockModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update Stock for Selected Products</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Action</label>
          <select class="form-control" id="stockAction">
            <option value="set">Set stock to specific amount</option>
            <option value="add">Add to current stock</option>
            <option value="subtract">Subtract from current stock</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input type="number" class="form-control" id="stockAmount" min="0">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="confirmBulkStock()">Update Stock</button>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Visibility Modal -->
<div class="modal fade" id="bulkVisibilityModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Toggle Visibility for Selected Products</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Visibility Action</label>
          <select class="form-control" id="visibilityAction">
            <option value="show">Make All Selected Live</option>
            <option value="hide">Hide All Selected</option>
            <option value="toggle">Toggle Each Product's Visibility</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="confirmBulkVisibility()">Update Visibility</button>
      </div>
    </div>
  </div>
</div>

<!-- CSRF Token -->
{% csrf_token %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    let editMode = false;
    let selectedProducts = new Set();
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Search functionality
    document.getElementById('productSearch').addEventListener('input', filterProducts);
    document.getElementById('statusFilter').addEventListener('change', filterProducts);
    document.getElementById('stockFilter').addEventListener('change', filterProducts);
    
    // Bulk mode toggle
    window.toggleBulkMode = function() {
        editMode = !editMode;
        const bulkSelects = document.querySelectorAll('.bulk-select');
        const bulkActions = document.getElementById('bulkActions');
        const editIcons = document.querySelectorAll('.edit-icon');
        
        if (editMode) {
            bulkSelects.forEach(el => el.style.display = 'block');
            bulkActions.style.display = 'block';
            editIcons.forEach(el => el.style.display = 'inline');
        } else {
            bulkSelects.forEach(el => el.style.display = 'none');
            bulkActions.style.display = 'none';
            editIcons.forEach(el => el.style.display = 'none');
            selectedProducts.clear();
            updateSelectedCount();
        }
    };
    
    // Product selection - only approved products
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-checkbox') && !e.target.disabled) {
            const productId = e.target.value;
            if (e.target.checked) {
                selectedProducts.add(productId);
            } else {
                selectedProducts.delete(productId);
            }
            updateSelectedCount();
        }
        
        if (e.target.id === 'selectAll') {
            const checkboxes = document.querySelectorAll('.product-checkbox:not(:disabled)');
            checkboxes.forEach(cb => {
                cb.checked = e.target.checked;
                if (e.target.checked) {
                    selectedProducts.add(cb.value);
                } else {
                    selectedProducts.delete(cb.value);
                }
            });
            updateSelectedCount();
        }
    });
    
    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = `${selectedProducts.size} selected`;
    }
    
    function filterProducts() {
        const search = document.getElementById('productSearch').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        const stock = document.getElementById('stockFilter').value;
        
        document.querySelectorAll('.product-item').forEach(item => {
            const name = item.dataset.name;
            const itemStatus = item.dataset.status;
            const itemStock = parseInt(item.dataset.stock);
            
            let show = true;
            
            if (search && !name.includes(search)) show = false;
            if (status && itemStatus !== status) show = false;
            if (stock) {
                if (stock === 'low' && itemStock > 5) show = false;
                if (stock === 'out' && itemStock > 0) show = false;
                if (stock === 'good' && itemStock <= 5) show = false;
            }
            
            item.style.display = show ? 'block' : 'none';
        });
    }
    
    window.clearFilters = function() {
        document.getElementById('productSearch').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('stockFilter').value = '';
        filterProducts();
    };
    
    // Stock adjustment - with permission check
    window.adjustStock = function(productId, change) {
        const input = document.querySelector(`input[data-product="${productId}"]`);
        if (input.readOnly) {
            showToast('Only approved products can have stock updated', 'error');
            return;
        }
        
        const newValue = Math.max(0, parseInt(input.value) + change);
        input.value = newValue;
        updateStock(productId, newValue);
    };
    
    // Quick stock update for out of stock products
    window.quickStockUpdate = function(productId, amount) {
        const input = document.querySelector(`input[data-product="${productId}"]`);
        input.value = amount;
        updateStock(productId, amount);
    };
    
    window.updateStock = function(productId, newStock) {
        fetch(`/users/update-product-stock/${productId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({stock: newStock})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update stock indicator
                const item = document.querySelector(`[data-product="${productId}"]`).closest('.product-item');
                item.dataset.stock = newStock;
                
                // Update stock status indicators
                updateStockIndicators(productId, newStock);
                
                showToast('Stock updated successfully', 'success');
            } else {
                showToast(data.message || 'Error updating stock', 'error');
                // Revert the input value
                const input = document.querySelector(`input[data-product="${productId}"]`);
                input.value = data.original_stock || input.value;
            }
        })
        .catch(error => {
            showToast('Network error updating stock', 'error');
        });
    };
    
    function updateStockIndicators(productId, newStock) {
        const productCard = document.querySelector(`[data-product="${productId}"]`).closest('.product-item');
        const stockIndicator = productCard.querySelector('.col-md-2 small:last-child');
        
        if (newStock == 0) {
            stockIndicator.innerHTML = '<i class="fa fa-exclamation-triangle"></i> Out of Stock';
            stockIndicator.className = 'text-danger';
        } else if (newStock <= 5) {
            stockIndicator.innerHTML = '<i class="fa fa-exclamation-circle"></i> Low Stock';
            stockIndicator.className = 'text-warning';
        } else {
            stockIndicator.innerHTML = '<i class="fa fa-check-circle"></i> In Stock';
            stockIndicator.className = 'text-success';
        }
    }
    
    window.toggleProductStatus = function(productId) {
        const checkbox = document.getElementById(`status${productId}`);
        const isLive = checkbox.checked;
        
        fetch(`/users/toggle-product-status/${productId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({status: isLive})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const label = checkbox.nextElementSibling.querySelector('.visibility-label');
                label.textContent = isLive ? 'üü¢ Live' : 'üî¥ Hidden';
                showToast(`Product ${isLive ? 'made live' : 'hidden'}`, 'success');
            } else {
                checkbox.checked = !isLive; // Revert on error
                showToast(data.message || 'Error updating product status', 'error');
            }
        })
        .catch(error => {
            checkbox.checked = !isLive; // Revert on error
            showToast('Network error updating product status', 'error');
        });
    };
    
    window.deleteProduct = function(productId) {
        if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
            fetch(`/users/delete-product/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector(`[data-product="${productId}"]`).closest('.product-item').remove();
                    showToast('Product deleted successfully', 'success');
                } else {
                    showToast(data.message || 'Error deleting product', 'error');
                }
            })
            .catch(error => {
                showToast('Network error deleting product', 'error');
            });
        }
    };
    
    window.duplicateProduct = function(productId) {
        if (confirm('Create a copy of this product?')) {
            fetch(`/users/duplicate-product/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Product duplicated successfully', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || 'Error duplicating product', 'error');
                }
            })
            .catch(error => {
                showToast('Network error duplicating product', 'error');
            });
        }
    };
    
    window.editProductModal = function(productId) {
        $('#quickEditModal').modal('show');
        document.getElementById('quickEditContent').innerHTML = '<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading...</div>';
        
        fetch(`/users/edit-product/${productId}/`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('quickEditContent').innerHTML = html;
            })
            .catch(error => {
                document.getElementById('quickEditContent').innerHTML = '<div class="text-center text-danger">Error loading product details</div>';
            });
    };
    
    window.showRejectionReason = function(reason) {
        alert(`Rejection Reason:\n\n${reason}\n\nPlease fix the issues and contact admin for re-review.`);
    };
    
    window.bulkUpdateStock = function() {
        if (selectedProducts.size === 0) {
            showToast('Please select approved products first', 'warning');
            return;
        }
        $('#bulkStockModal').modal('show');
    };
    
    window.bulkToggleVisibility = function() {
        if (selectedProducts.size === 0) {
            showToast('Please select approved products first', 'warning');
            return;
        }
        $('#bulkVisibilityModal').modal('show');
    };
    
    window.confirmBulkStock = function() {
        const action = document.getElementById('stockAction').value;
        const amount = parseInt(document.getElementById('stockAmount').value);
        
        if (!amount && amount !== 0) {
            showToast('Please enter a valid amount', 'warning');
            return;
        }
        
        fetch('/users/bulk-update-stock/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                products: Array.from(selectedProducts),
                action: action,
                amount: amount
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#bulkStockModal').modal('hide');
                showToast(`Stock updated for ${data.updated_count} products`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message || 'Error updating stock', 'error');
            }
        })
        .catch(error => {
            showToast('Network error updating stock', 'error');
        });
    };
    
    window.confirmBulkVisibility = function() {
        const action = document.getElementById('visibilityAction').value;
        
        fetch('/users/bulk-toggle-visibility/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                products: Array.from(selectedProducts),
                action: action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#bulkVisibilityModal').modal('hide');
                showToast(`Visibility updated for ${data.updated_count} products`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message || 'Error updating visibility', 'error');
            }
        })
        .catch(error => {
            showToast('Network error updating visibility', 'error');
        });
    };
    
    window.bulkDelete = function() {
        if (selectedProducts.size === 0) {
            showToast('Please select products first', 'warning');
            return;
        }
        
        if (confirm(`Are you sure you want to delete ${selectedProducts.size} selected products?`)) {
            fetch('/users/bulk-delete-products/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    products: Array.from(selectedProducts)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`${data.deleted_count} products deleted`, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || 'Error deleting products', 'error');
                }
            })
            .catch(error => {
                showToast('Network error deleting products', 'error');
            });
        }
    };
    
    function showToast(message, type) {
        // Remove existing toasts
        document.querySelectorAll('.toast-notification').forEach(t => t.remove());
        
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} toast-notification`;
        toast.style.position = 'fixed';
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.zIndex = '9999';
        toast.style.minWidth = '300px';
        toast.innerHTML = `
            <i class="fa fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
            ${message}
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
});
</script>

<style>
.editable-field:hover[data-editable="true"] {
    background-color: #f8f9fa;
    border-radius: 3px;
    padding: 2px 4px;
    cursor: text;
}

.product-locked {
    opacity: 0.8;
    border-left: 3px solid #ffc107;
}

.product-locked .editable-field {
    cursor: not-allowed;
}

.custom-control-label small {
    font-size: 0.8em;
}

.toast-notification {
    animation: slideIn 0.3s ease-in-out;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.stock-input:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.visibility-label {
    font-weight: 500;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.dropdown-item:disabled {
    color: #6c757d;
    pointer-events: none;
    background-color: transparent;
}
</style>

{% endblock %}