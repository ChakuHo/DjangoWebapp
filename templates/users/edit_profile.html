{% extends "master/base.html" %} 
{% load static %} 
{% block content %}

<section class="section-conten padding-y bg">
  <div class="container">
    <div class="row">
      {% include 'users/includes/sidebar.html' %}

      <main class="col-md-9">
        <!-- Display Messages -->
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          {% endfor %}
        {% endif %}

        <!-- Display Errors -->
        {% if error %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          {{ error }}
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        {% endif %}

        <article class="card shadow-sm">
          <header class="card-header bg-light">
            <strong class="d-inline-block mr-3">
              <i class="fa fa-user-edit mr-2"></i>Edit your profile
            </strong>
          </header>
          <div class="card-body">
            <!-- Profile Picture Preview -->
            <div class="text-center mb-4">
              <div class="profile-picture-wrapper position-relative d-inline-block" onclick="document.getElementById('customFile').click()" style="cursor: pointer;">
                {% if profile.profile_picture %}
                <!-- User has profile picture -->
                <img
                  src="{{ profile.profile_picture.url }}"
                  alt="Profile Picture"
                  id="profile-preview"
                  class="profile-image rounded-circle shadow-sm"
                  width="120"
                  height="120"
                />
                {% else %}
                <!-- No profile picture - show initials like Facebook -->
                <div class="profile-initials rounded-circle shadow-sm d-flex align-items-center justify-content-center" 
                     id="profile-initials"
                     style="width: 120px; height: 120px;">
                  <span class="initials-text"></span>
                </div>
                <img id="profile-preview" class="profile-image rounded-circle shadow-sm" 
                     width="120" height="120" style="display: none;" />
                {% endif %}
                
                <!-- Edit Overlay (like Facebook) -->
                <div class="profile-edit-overlay rounded-circle position-absolute">
                  <div class="edit-content">
                    <i class="fa fa-camera mb-1"></i>
                    <div class="edit-text">Edit</div>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <small class="text-muted">
                  <i class="fa fa-info-circle mr-1"></i>
                  Click to change profile picture
                </small>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12">
                <form
                  action="{% url 'edit_profile' %}"
                  method="POST"
                  enctype="multipart/form-data"
                  novalidate
                  id="profile-form"
                >
                  {% csrf_token %}
                  
                  <!-- Basic Information -->
                  <div class="form-section">
                    <h6 class="section-title mb-3">
                      <i class="fa fa-user mr-2 text-primary"></i>Basic Information
                    </h6>
                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label for="id_first_name">First Name *</label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fa fa-user"></i></span>
                          </div>
                          <input
                            type="text"
                            name="first_name"
                            value="{{ request.user.first_name }}"
                            maxlength="50"
                            class="form-control"
                            required
                            id="id_first_name"
                            placeholder="Enter your first name"
                          />
                          <div class="invalid-feedback"></div>
                          <div class="valid-feedback">Looks good!</div>
                        </div>
                      </div>
                      <div class="form-group col-md-6">
                        <label for="id_last_name">Last Name *</label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fa fa-user"></i></span>
                          </div>
                          <input
                            type="text"
                            name="last_name"
                            value="{{ request.user.last_name }}"
                            maxlength="50"
                            class="form-control"
                            required
                            id="id_last_name"
                            placeholder="Enter your last name"
                          />
                          <div class="invalid-feedback"></div>
                          <div class="valid-feedback">Looks good!</div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Contact Information -->
                  <div class="form-section">
                    <h6 class="section-title mb-3">
                      <i class="fa fa-phone mr-2 text-primary"></i>Contact Information
                    </h6>
                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label for="id_phone_number">Phone Number</label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fa fa-phone"></i></span>
                          </div>
                          <input
                            type="tel"
                            name="phone_number"
                            value="{{ profile.phone_number|default:'' }}"
                            maxlength="15"
                            class="form-control"
                            id="id_phone_number"
                            placeholder="9812345678"
                            pattern="^(\+977)?[0-9]{7,10}$"
                          />
                          <div class="invalid-feedback"></div>
                          <div class="valid-feedback">Valid phone number!</div>
                        </div>
                        <small class="form-text text-muted">
                          <i class="fa fa-info-circle mr-1"></i>
                          Nepal: 10 digits (98XXXXXXXX), Landline: 7-8 digits, International: +977XXXXXXXXXX
                        </small>
                      </div>
                      <div class="form-group col-md-6">
                        <label for="customFile">Profile Picture</label>
                        <input
                          type="file"
                          name="profile_picture"
                          accept="image/jpeg,image/jpg,image/png,image/webp"
                          class="form-control"
                          id="id_profile_picture"
                          style="display: none;"
                        />
                        <div class="custom-file">
                          <input type="file" class="custom-file-input" id="customFile" 
                                 accept="image/jpeg,image/jpg,image/png,image/webp">
                          <label class="custom-file-label" for="customFile">Choose file</label>
                        </div>
                        <small class="form-text text-muted">
                          <i class="fa fa-image mr-1"></i>
                          JPG, PNG, WebP only. Max size: 5MB
                        </small>
                        <div class="file-error text-danger mt-1" style="display: none;"></div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Address Information -->
                  <div class="form-section">
                    <h6 class="section-title mb-3">
                      <i class="fa fa-map-marker-alt mr-2 text-primary"></i>Address Information
                    </h6>
                    <div class="form-group">
                      <label for="id_address_line_1">Address Line 1</label>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="fa fa-home"></i></span>
                        </div>
                        <input
                          type="text"
                          name="address_line_1"
                          maxlength="100"
                          value="{{ profile.address_line_1|default:'' }}"
                          class="form-control"
                          id="id_address_line_1"
                          placeholder="Street address, house number"
                        />
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="id_address_line_2">Address Line 2</label>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="fa fa-building"></i></span>
                        </div>
                        <input
                          type="text"
                          name="address_line_2"
                          maxlength="100"
                          value="{{ profile.address_line_2|default:'' }}"
                          class="form-control"
                          id="id_address_line_2"
                          placeholder="Apartment, suite, floor (optional)"
                        />
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group col-md-4">
                        <label for="id_city">City</label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fa fa-city"></i></span>
                          </div>
                          <input
                            type="text"
                            name="city"
                            value="{{ profile.city|default:'' }}"
                            maxlength="30"
                            class="form-control"
                            id="id_city"
                            placeholder="Your city"
                          />
                        </div>
                      </div>
                      <div class="form-group col-md-4">
                        <label for="id_state">State/Province</label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fa fa-map"></i></span>
                          </div>
                          <input
                            type="text"
                            name="state"
                            value="{{ profile.state|default:'' }}"
                            maxlength="30"
                            class="form-control"
                            id="id_state"
                            placeholder="Your state/province"
                          />
                        </div>
                      </div>
                      <div class="form-group col-md-4">
                        <label for="id_country">Country</label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fa fa-flag"></i></span>
                          </div>
                          <select name="country" class="form-control" id="id_country">
                            <option value="">Select Country</option>
                            <option value="Nepal" {% if profile.country == 'Nepal' %}selected{% endif %}>üá≥üáµ Nepal</option>
                            <option value="India" {% if profile.country == 'India' %}selected{% endif %}>üáÆüá≥ India</option>
                            <option value="USA" {% if profile.country == 'USA' %}selected{% endif %}>üá∫üá∏ United States</option>
                            <option value="UK" {% if profile.country == 'UK' %}selected{% endif %}>üá¨üáß United Kingdom</option>
                            <option value="Canada" {% if profile.country == 'Canada' %}selected{% endif %}>üá®üá¶ Canada</option>
                            <option value="Australia" {% if profile.country == 'Australia' %}selected{% endif %}>üá¶üá∫ Australia</option>
                            <option value="Other" {% if profile.country and profile.country not in 'Nepal,India,USA,UK,Canada,Australia' %}selected{% endif %}>üåç Other</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="form-group mt-4 text-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5 mr-3">
                      <i class="fa fa-save mr-2"></i>Save Changes
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-lg px-4">
                      <i class="fa fa-times mr-2"></i>Cancel
                    </a>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </article>
      </main>
    </div>
  </div>
</section>

<!-- Enhanced Styling -->
<style>
.form-section {
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid #e9ecef;
}

.form-section:last-child {
  border-bottom: none;
}

.section-title {
  color: #495057;
  font-weight: 600;
  border-left: 3px solid #007bff;
  padding-left: 10px;
}

.input-group-text {
  background-color: #f8f9fa;
  border-color: #ced4da;
  color: #6c757d;
}

.form-control:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Profile Picture Styles - Facebook Like */
.profile-picture-wrapper {
  position: relative;
  transition: all 0.3s ease;
}

.profile-image {
  object-fit: cover;
  border: 3px solid #e9ecef;
  transition: all 0.3s ease;
}

.profile-initials {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: 3px solid #e9ecef;
  color: white;
  font-weight: 600;
  transition: all 0.3s ease;
}

.initials-text {
  font-size: 2.5rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
}

/* Edit Overlay - Facebook Style */
.profile-edit-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 120px;
  height: 120px;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.3s ease;
  cursor: pointer;
}

.profile-picture-wrapper:hover .profile-edit-overlay {
  opacity: 1;
}

.edit-content {
  text-align: center;
}

.edit-content i {
  font-size: 1.5rem;
  display: block;
}

.edit-text {
  font-size: 0.85rem;
  font-weight: 600;
  margin-top: 2px;
}

.profile-picture-wrapper:hover .profile-image,
.profile-picture-wrapper:hover .profile-initials {
  transform: scale(1.05);
  border-color: #007bff;
}

.btn-primary {
  background: linear-gradient(45deg, #007bff, #0056b3);
  border: none;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
}

.card {
  border: none;
  border-radius: 15px;
}

.card-header {
  border-radius: 15px 15px 0 0 !important;
}

/* Color variations for initials */
.profile-initials.color-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.profile-initials.color-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.profile-initials.color-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.profile-initials.color-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.profile-initials.color-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
.profile-initials.color-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
.profile-initials.color-7 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
.profile-initials.color-8 { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
</style>

<!-- FIXED Client-side Validation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('id_phone_number');
    const form = document.getElementById('profile-form');
    const firstNameInput = document.getElementById('id_first_name');
    const lastNameInput = document.getElementById('id_last_name');
    
    // Initialize profile picture display
    initializeProfilePicture();
    
    function initializeProfilePicture() {
        const hasProfilePic = {% if profile.profile_picture %}true{% else %}false{% endif %};
        
        if (!hasProfilePic) {
            showUserInitials();
        }
    }
    
    function showUserInitials() {
        const firstName = "{{ request.user.first_name|default:'' }}";
        const lastName = "{{ request.user.last_name|default:'' }}";
        const username = "{{ request.user.username|default:'' }}";
        
        let initials = '';
        
        if (firstName && lastName) {
            initials = firstName.charAt(0) + lastName.charAt(0);
        } else if (firstName) {
            initials = firstName.charAt(0) + (firstName.charAt(1) || '');
        } else if (username) {
            initials = username.charAt(0) + (username.charAt(1) || '');
        } else {
            initials = 'U';
        }
        
        const initialsElement = document.getElementById('profile-initials');
        const initialsText = initialsElement.querySelector('.initials-text');
        
        if (initialsText) {
            initialsText.textContent = initials.toUpperCase();
            
            // Add random color class
            const colorIndex = (initials.charCodeAt(0) % 8) + 1;
            initialsElement.classList.add(`color-${colorIndex}`);
            
            initialsElement.style.display = 'flex';
        }
    }
    
    // Update initials when name changes
    function updateInitials() {
        const firstName = firstNameInput.value.trim();
        const lastName = lastNameInput.value.trim();
        const username = "{{ request.user.username|default:'' }}";
        
        let initials = '';
        
        if (firstName && lastName) {
            initials = firstName.charAt(0) + lastName.charAt(0);
        } else if (firstName) {
            initials = firstName.charAt(0) + (firstName.charAt(1) || '');
        } else if (username) {
            initials = username.charAt(0) + (username.charAt(1) || '');
        } else {
            initials = 'U';
        }
        
        const initialsText = document.querySelector('.initials-text');
        if (initialsText) {
            initialsText.textContent = initials.toUpperCase();
        }
    }
    
    firstNameInput.addEventListener('input', updateInitials);
    lastNameInput.addEventListener('input', updateInitials);
    
    // FIXED: Phone number validation - NUMBERS ONLY
    phoneInput.addEventListener('input', function(e) {
        // Remove any non-digit characters except + at the beginning
        let value = e.target.value;
        let cursorPosition = e.target.selectionStart;
        
        // Allow + only at the beginning
        if (value.startsWith('+')) {
            value = '+' + value.slice(1).replace(/[^\d]/g, '');
        } else {
            value = value.replace(/[^\d]/g, '');
        }
        
        // Update the input value
        e.target.value = value;
        
        // Restore cursor position
        e.target.setSelectionRange(cursorPosition, cursorPosition);
        
        // Validate
        validatePhoneNumber(this);
    });
    
    phoneInput.addEventListener('keypress', function(e) {
        // Allow only numbers, backspace, delete, tab, escape, enter, and +
        const allowedKeys = [8, 9, 27, 13, 46, 43]; // backspace, tab, escape, enter, delete, +
        const isNumber = (e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 105);
        const isPlus = e.keyCode === 43 && this.value.length === 0; // + only at beginning
        
        if (!isNumber && !allowedKeys.includes(e.keyCode) && !isPlus) {
            e.preventDefault();
        }
    });
    
    function validatePhoneNumber(input) {
        const phone = input.value.trim();
        input.classList.remove('is-valid', 'is-invalid');
        
        if (phone === '') {
            input.setCustomValidity('');
            return;
        }
        
        let isValid = false;
        let errorMessage = '';
        
        if (phone.startsWith('+977')) {
            // International Nepal format: +977XXXXXXXXXX
            const localPart = phone.substring(4);
            if (localPart.length === 10 && localPart.startsWith('98')) {
                // Mobile: +977 98XXXXXXXX
                isValid = true;
            } else if (localPart.length >= 7 && localPart.length <= 8) {
                // Landline: +977 XXXXXXX or +977 XXXXXXXX
                isValid = true;
            } else {
                errorMessage = 'Invalid Nepal number format. Use +977 98XXXXXXXX (mobile) or +977 XXXXXXX (landline)';
            }
        } else if (phone.startsWith('+')) {
            // Other international numbers
            if (phone.length >= 10 && phone.length <= 15) {
                isValid = true;
            } else {
                errorMessage = 'International number should be 10-15 digits including country code';
            }
        } else {
            // Local Nepal numbers
            if (phone.length === 10 && phone.startsWith('98')) {
                // Mobile: 98XXXXXXXX
                isValid = true;
            } else if (phone.length >= 7 && phone.length <= 8) {
                // Landline: XXXXXXX or XXXXXXXX
                isValid = true;
            } else {
                errorMessage = 'Enter 98XXXXXXXX (mobile) or 7-8 digits (landline)';
            }
        }
        
        if (isValid) {
            input.classList.add('is-valid');
            input.setCustomValidity('');
        } else {
            input.classList.add('is-invalid');
            input.setCustomValidity(errorMessage);
            const feedback = input.parentNode.querySelector('.invalid-feedback');
            if (feedback) {
                feedback.textContent = errorMessage;
            }
        }
    }
    
    // Name validation - LETTERS ONLY
    function validateName(input) {
        input.addEventListener('input', function(e) {
            // Remove any non-letter characters except spaces
            let value = e.target.value;
            let cursorPosition = e.target.selectionStart;
            
            value = value.replace(/[^A-Za-z\s]/g, '');
            
            e.target.value = value;
            e.target.setSelectionRange(cursorPosition, cursorPosition);
            
            // Validate
            const name = value.trim();
            this.classList.remove('is-valid', 'is-invalid');
            
            if (name === '') {
                this.classList.add('is-invalid');
                this.setCustomValidity('This field is required');
                const feedback = this.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.textContent = 'This field is required';
                }
            } else if (name.length < 2) {
                this.classList.add('is-invalid');
                this.setCustomValidity('Name must be at least 2 characters long');
                const feedback = this.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.textContent = 'Name must be at least 2 characters long';
                }
            } else if (name.length > 50) {
                this.classList.add('is-invalid');
                this.setCustomValidity('Name cannot exceed 50 characters');
                const feedback = this.parentNode.querySelector('.invalid-feedback');
                if (feedback) {
                    feedback.textContent = 'Name cannot exceed 50 characters';
                }
            } else {
                this.classList.add('is-valid');
                this.setCustomValidity('');
            }
        });
        
        input.addEventListener('keypress', function(e) {
            // Allow only letters and space
            const isLetter = (e.keyCode >= 65 && e.keyCode <= 90) || (e.keyCode >= 97 && e.keyCode <= 122);
            const isSpace = e.keyCode === 32;
            const allowedKeys = [8, 9, 27, 13, 46]; // backspace, tab, escape, enter, delete
            
            if (!isLetter && !isSpace && !allowedKeys.includes(e.keyCode)) {
                e.preventDefault();
            }
        });
    }
    
    validateName(firstNameInput);
    validateName(lastNameInput);
    
    // File handling with preview
    document.getElementById('customFile').addEventListener('change', function() {
        const fileInput = document.getElementById('id_profile_picture');
        const file = this.files[0];
        const errorDiv = document.querySelector('.file-error');
        const label = this.nextElementSibling;
        
        if (file) {
            // File size validation (5MB)
            if (file.size > 5 * 1024 * 1024) {
                errorDiv.textContent = 'File size should be less than 5MB';
                errorDiv.style.display = 'block';
                this.value = '';
                label.textContent = 'Choose file';
                return;
            }
            
            // File type validation
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                errorDiv.textContent = 'Only JPG, PNG, and WebP files are allowed';
                errorDiv.style.display = 'block';
                this.value = '';
                label.textContent = 'Choose file';
                return;
            }
            
            // Update label and clear errors
            label.textContent = file.name;
            errorDiv.style.display = 'none';
            
            // Update hidden input
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;
            
            // Preview image - show image and hide initials
            const reader = new FileReader();
            reader.onload = function(e) {
                const profilePreview = document.getElementById('profile-preview');
                const profileInitials = document.getElementById('profile-initials');
                
                profilePreview.src = e.target.result;
                profilePreview.style.display = 'block';
                if (profileInitials) {
                    profileInitials.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        } else {
            label.textContent = 'Choose file';
            errorDiv.style.display = 'none';
        }
    });
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Check all required fields
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            }
        });
        
        // Check phone validation if phone has value
        if (phoneInput.value.trim() && !phoneInput.checkValidity()) {
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            // Scroll to first invalid field
            const firstInvalid = form.querySelector('.is-invalid');
            if (firstInvalid) {
                firstInvalid.focus();
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
});
</script>

{% endblock %}