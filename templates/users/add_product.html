{% extends "master/base.html" %} {% load static %} {% block content %}

<section class="section-content padding-y bg">
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h4><i class="fa fa-plus text-primary"></i> Add New Product</h4>
        <p class="text-muted mb-0">Fill in the details below to list your product</p>
      </div>
      
      <div class="card-body">
        <form method="POST" action="{% url 'add_product' %}" enctype="multipart/form-data" id="add-product-form">
          {% csrf_token %}
          
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert">
                  <span>&times;</span>
                </button>
              </div>
            {% endfor %}
          {% endif %}

          <div class="row">
            <!-- Left Column - Basic Info -->
            <div class="col-md-6">
              <h6 class="text-muted mb-3">üìù Basic Information</h6>
              
              <div class="form-group">
                <label for="name">Product Name *</label>
                <input type="text" name="name" id="name" class="form-control" required maxlength="255">
              </div>

              <div class="form-group">
                <label for="description">Description *</label>
                <textarea name="description" id="description" class="form-control" rows="4" required></textarea>
              </div>

              <div class="form-row">
                <div class="form-group col-md-6">
                  <label for="price">Price (Rs.) *</label>
                  <input type="number" name="price" id="price" class="form-control" step="0.01" min="0" required>
                </div>
                <div class="form-group col-md-6">
                  <label for="stock">Stock Quantity *</label>
                  <input type="number" name="stock" id="stock" class="form-control" min="0" required>
                </div>
              </div>

              <div class="form-group">
                <label for="category">Category *</label>
                <select name="category" id="category" class="form-control" required onchange="updateVariationDisplay()">
                  <option value="">Select a category</option>
                  {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.category_name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group">
                <label for="brand">Brand</label>
                <input type="text" name="brand" id="brand" class="form-control" maxlength="100">
              </div>

              <div class="form-group">
                <label for="spec">Specifications</label>
                <input type="text" name="spec" id="spec" class="form-control" maxlength="255">
              </div>

              <div class="form-group">
                <label for="image">Main Product Image</label>
                <input type="file" name="image" id="image" class="form-control-file" accept="image/*">
                <small class="form-text text-muted">Upload main product image</small>
              </div>

              <!-- Product Type & Condition Section -->
              <div class="card mb-4">
                <div class="card-header">
                  <h6 class="mb-0">üì¶ Product Type & Condition</h6>
                </div>
                <div class="card-body">
                  <div class="form-group">
                    <label for="product_type">Product Type <span class="text-danger">*</span></label>
                    <select name="product_type" id="product_type" class="form-control" required>
                      <option value="new">üÜï New Product</option>
                      <option value="thrift">‚ôªÔ∏è Thrift/Used Product</option>
                      <option value="refurbished">üîß Refurbished Product</option>
                    </select>
                  </div>
                  
                  <!-- Condition (only for thrift/refurbished) -->
                  <div class="form-group" id="condition-group" style="display: none;">
                    <label for="condition">Condition <span class="text-danger">*</span></label>
                    <select name="condition" id="condition" class="form-control">
                      <option value="">Select condition</option>
                      <option value="excellent">‚≠ê Excellent - Like New</option>
                      <option value="good">üëç Good - Minor wear</option>
                      <option value="fair">üëå Fair - Noticeable wear</option>
                      <option value="poor">‚ö†Ô∏è Poor - Heavy wear</option>
                    </select>
                  </div>
                  
                  <!-- Years Used (only for thrift) -->
                  <div class="form-group" id="years-used-group" style="display: none;">
                    <label for="years_used">Years Used</label>
                    <select name="years_used" id="years_used" class="form-control">
                      <option value="">How long was it used?</option>
                      <option value="1">Less than 1 year</option>
                      <option value="1">1 year</option>
                      <option value="2">2 years</option>
                      <option value="3">3 years</option>
                      <option value="4">4 years</option>
                      <option value="5">5+ years</option>
                    </select>
                  </div>
                  
                  <div class="alert alert-info mt-3">
                    <small><i class="fa fa-info-circle"></i> 
                    <strong>New:</strong> Brand new products<br>
                    <strong>Thrift:</strong> Previously used items<br>
                    <strong>Refurbished:</strong> Restored to working condition</small>
                  </div>
                </div>
              </div>

              <!-- Sale & Discount Section -->
              <div class="card mb-4">
                <div class="card-header">
                  <h6 class="mb-0">üî• Sale & Discount (Optional)</h6>
                </div>
                <div class="card-body">
                  <div class="form-group">
                    <div class="custom-control custom-checkbox">
                      <input type="checkbox" class="custom-control-input" id="is_on_sale" name="is_on_sale">
                      <label class="custom-control-label" for="is_on_sale">
                        <strong>üî• Put this product on sale</strong>
                      </label>
                    </div>
                  </div>
                  
                  <div id="sale-details" style="display: none;">
                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label for="original_price">Original Price (Rs.) <span class="text-danger">*</span></label>
                        <input type="number" name="original_price" id="original_price" 
                               class="form-control" placeholder="1000" step="0.01" min="0">
                        <small class="text-muted">Price before discount</small>
                      </div>
                      <div class="form-group col-md-6">
                        <label for="discount_percentage">Discount % <span class="text-danger">*</span></label>
                        <input type="number" name="discount_percentage" id="discount_percentage" 
                               class="form-control" placeholder="20" min="1" max="90">
                        <small class="text-muted">1-90% discount</small>
                      </div>
                    </div>
                    
                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label for="sale_start_date">Sale Start Date</label>
                        <input type="date" name="sale_start_date" id="sale_start_date" class="form-control">
                      </div>
                      <div class="form-group col-md-6">
                        <label for="sale_end_date">Sale End Date</label>
                        <input type="date" name="sale_end_date" id="sale_end_date" class="form-control">
                      </div>
                    </div>
                    
                    <div class="alert alert-success">
                      <small><i class="fa fa-lightbulb"></i> 
                      <strong>Final Price Preview:</strong> <span id="final-price-preview">Rs. 0</span><br>
                      <strong>Customer Saves:</strong> <span id="savings-preview">Rs. 0</span></small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column - Variations -->
            <div class="col-md-6">
              <h6 class="text-muted mb-3">üé® Product Variations</h6>
              
              <!-- NEW: Variation Type Selection -->
              <div class="card mb-4" id="variation-type-selection">
                <div class="card-header">
                  <h6 class="mb-0">Select Variation Types</h6>
                  <small class="text-muted">Choose which variations customers can select for this product</small>
                </div>
                <div class="card-body">
                  <div class="variation-types-list">
                    {% for vtype in variation_types %}
                      <div class="custom-control custom-checkbox mb-2">
                        <input type="checkbox" 
                               name="enabled_variation_types" 
                               value="{{ vtype.id }}" 
                               class="custom-control-input variation-type-checkbox" 
                               id="vtype_{{ vtype.id }}"
                               onchange="updateVariationDisplay()">
                        <label class="custom-control-label" for="vtype_{{ vtype.id }}">
                          <strong>{{ vtype.display_name }}</strong>
                          <small class="text-muted d-block">
                            {% if vtype.name == "Color" %}
                              Allow customers to choose from different colors
                            {% elif vtype.name == "Size" %}
                              Allow customers to choose from different sizes
                            {% elif vtype.name == "Storage" %}
                              Allow customers to choose storage capacity
                            {% else %}
                              Allow customers to choose from different {{ vtype.name|lower }} options
                            {% endif %}
                          </small>
                        </label>
                      </div>
                    {% endfor %}
                  </div>
                  
                  <div class="alert alert-info mt-3">
                    <i class="fa fa-info-circle"></i>
                    <strong>Note:</strong> Select the variation types first, then configure specific options below.
                  </div>
                </div>
              </div>

              <!-- Enhanced Variations Configuration -->
              <div id="variations-section">
                <p class="text-muted">Select variation types above to configure options</p>
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="form-group mt-4">
            <div class="row">
              <div class="col-md-6">
                <button type="submit" class="btn btn-primary btn-block btn-lg">
                  <i class="fa fa-paper-plane"></i> Submit for Review
                </button>
              </div>
              <div class="col-md-6">
                <a href="{% url 'my_selling_items' %}" class="btn btn-outline-secondary btn-block btn-lg">
                  <i class="fa fa-times"></i> Cancel
                </a>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<style>
/* Enhanced styling */
.variation-types-list {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 15px;
  background: #f8f9fa;
}

.custom-control-label strong {
  color: #495057;
}

.variation-group {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  background: #ffffff;
}

.variation-group h6 {
  color: #495057;
  border-bottom: 1px solid #e9ecef;
  padding-bottom: 8px;
  margin-bottom: 15px;
}

.variation-fields {
  background: #f8f9fa;
  padding: 10px;
  border-radius: 6px;
  border-left: 3px solid #007bff;
}

.card-header h6 {
  color: #495057;
  font-weight: 600;
}
</style>

<script>
// Enhanced variation management
const categoryVariations = {{ category_variations|safe }};
let selectedVariationTypes = new Set();

// Product type and sale management
document.addEventListener('DOMContentLoaded', function() {
    const productTypeSelect = document.getElementById('product_type');
    const conditionGroup = document.getElementById('condition-group');
    const yearsUsedGroup = document.getElementById('years-used-group');
    const conditionSelect = document.getElementById('condition');
    const saleCheckbox = document.getElementById('is_on_sale');
    const saleDetails = document.getElementById('sale-details');
    const originalPriceInput = document.getElementById('original_price');
    const discountPercentageInput = document.getElementById('discount_percentage');
    const finalPricePreview = document.getElementById('final-price-preview');
    const savingsPreview = document.getElementById('savings-preview');
    
    // Show/hide condition and years based on product type
    productTypeSelect.addEventListener('change', function() {
        const productType = this.value;
        
        if (productType === 'thrift') {
            conditionGroup.style.display = 'block';
            yearsUsedGroup.style.display = 'block';
            conditionSelect.required = true;
        } else if (productType === 'refurbished') {
            conditionGroup.style.display = 'block';
            yearsUsedGroup.style.display = 'none';
            conditionSelect.required = true;
            document.getElementById('years_used').value = '';
        } else {
            conditionGroup.style.display = 'none';
            yearsUsedGroup.style.display = 'none';
            conditionSelect.required = false;
            conditionSelect.value = '';
            document.getElementById('years_used').value = '';
        }
    });
    
    // Show/hide sale details
    saleCheckbox.addEventListener('change', function() {
        if (this.checked) {
            saleDetails.style.display = 'block';
            originalPriceInput.required = true;
            discountPercentageInput.required = true;
        } else {
            saleDetails.style.display = 'none';
            originalPriceInput.required = false;
            discountPercentageInput.required = false;
            originalPriceInput.value = '';
            discountPercentageInput.value = '';
            updatePricePreview();
        }
    });
    
    // Update price preview
    function updatePricePreview() {
        const originalPrice = parseFloat(originalPriceInput.value) || 0;
        const discountPercent = parseFloat(discountPercentageInput.value) || 0;
        
        if (originalPrice > 0 && discountPercent > 0) {
            const finalPrice = originalPrice * (1 - discountPercent / 100);
            const savings = originalPrice - finalPrice;
            
            finalPricePreview.textContent = `Rs. ${finalPrice.toFixed(0)}`;
            savingsPreview.textContent = `Rs. ${savings.toFixed(0)}`;
        } else {
            finalPricePreview.textContent = 'Rs. 0';
            savingsPreview.textContent = 'Rs. 0';
        }
    }
    
    // Add event listeners for price preview
    originalPriceInput.addEventListener('input', updatePricePreview);
    discountPercentageInput.addEventListener('input', updatePricePreview);
    
    // Initialize variation display
    updateVariationDisplay();
});

function updateVariationDisplay() {
    const categoryId = document.getElementById('category').value;
    const variationsSection = document.getElementById('variations-section');
    
    // Get selected variation types
    selectedVariationTypes.clear();
    document.querySelectorAll('.variation-type-checkbox:checked').forEach(cb => {
        selectedVariationTypes.add(parseInt(cb.value));
    });
    
    if (!categoryId) {
        variationsSection.innerHTML = '<p class="text-muted">Select a category first</p>';
        return;
    }
    
    if (selectedVariationTypes.size === 0) {
        variationsSection.innerHTML = '<p class="text-muted">Select variation types above to configure options</p>';
        return;
    }
    
    if (!categoryVariations[categoryId] || categoryVariations[categoryId].length === 0) {
        variationsSection.innerHTML = '<p class="text-muted">No variations available for this category</p>';
        return;
    }
    
    let html = '<div class="alert alert-success"><i class="fa fa-check-circle"></i> Configure your selected variations</div>';
    
    // Filter category variations to only show selected types
    const filteredVariations = categoryVariations[categoryId].filter(catVar => 
        selectedVariationTypes.has(catVar.variation_type.id)
    );
    
    if (filteredVariations.length === 0) {
        variationsSection.innerHTML = '<div class="alert alert-warning"><i class="fa fa-exclamation-triangle"></i> Selected variation types are not available for this category</div>';
        return;
    }
    
    filteredVariations.forEach(catVar => {
        const varType = catVar.variation_type;
        html += `
            <div class="variation-group">
                <h6>${varType.display_name} ${catVar.is_required ? '*' : ''}</h6>
                <div class="variation-options">
        `;
        
        varType.options.forEach(option => {
            html += `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" 
                                   name="variation_${varType.id}_${option.id}_selected" 
                                   value="1" id="var_${varType.id}_${option.id}"
                                   onchange="toggleVariationFields(${varType.id}, ${option.id})">
                            <label class="form-check-label" for="var_${varType.id}_${option.id}">
                                <strong>${option.get_display_value || option.value}</strong>
                                ${option.color_code ? `<span class="color-indicator" style="background-color: ${option.color_code}; width: 20px; height: 20px; display: inline-block; border-radius: 50%; margin-left: 10px; border: 1px solid #ddd;"></span>` : ''}
                            </label>
                        </div>
                        
                        <div id="fields_${varType.id}_${option.id}" class="variation-fields mt-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-4">
                                    <label>Stock Quantity</label>
                                    <input type="number" name="variation_${varType.id}_${option.id}_stock" 
                                           class="form-control form-control-sm" min="0" value="0"
                                           placeholder="Available quantity">
                                </div>
                                <div class="col-md-4">
                                    <label>Price Adjustment (Rs.)</label>
                                    <input type="number" name="variation_${varType.id}_${option.id}_price_adjustment" 
                                           class="form-control form-control-sm" step="0.01" value="0"
                                           placeholder="Additional cost">
                                </div>
                                <div class="col-md-4">
                                    <label>SKU (Optional)</label>
                                    <input type="text" name="variation_${varType.id}_${option.id}_sku" 
                                           class="form-control form-control-sm"
                                           placeholder="Product code">
                                </div>
                            </div>
                            
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <label>Image 1</label>
                                    <input type="file" name="variation_${varType.id}_${option.id}_image1" 
                                           class="form-control-file form-control-sm" accept="image/*">
                                </div>
                                <div class="col-md-4">
                                    <label>Image 2</label>
                                    <input type="file" name="variation_${varType.id}_${option.id}_image2" 
                                           class="form-control-file form-control-sm" accept="image/*">
                                </div>
                                <div class="col-md-4">
                                    <label>Image 3</label>
                                    <input type="file" name="variation_${varType.id}_${option.id}_image3" 
                                           class="form-control-file form-control-sm" accept="image/*">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    variationsSection.innerHTML = html;
}

function toggleVariationFields(varTypeId, optionId) {
    const checkbox = document.getElementById(`var_${varTypeId}_${optionId}`);
    const fields = document.getElementById(`fields_${varTypeId}_${optionId}`);
    
    if (checkbox.checked) {
        fields.style.display = 'block';
        // Auto-focus on stock field
        const stockField = fields.querySelector('input[type="number"]');
        if (stockField) {
            setTimeout(() => stockField.focus(), 100);
        }
    } else {
        fields.style.display = 'none';
        // Clear values when unchecked
        fields.querySelectorAll('input').forEach(input => {
            if (input.type === 'number') {
                input.value = '0';
            } else {
                input.value = '';
            }
        });
    }
}

// Enhanced form validation
document.getElementById('add-product-form').addEventListener('submit', function(e) {
    let isValid = true;
    const requiredFields = ['name', 'description', 'category', 'price', 'stock'];
    
    requiredFields.forEach(field => {
        const input = document.querySelector(`[name="${field}"]`);
        if (!input.value.trim()) {
            isValid = false;
            input.classList.add('is-invalid');
        } else {
            input.classList.remove('is-invalid');
        }
    });
    
    // Check product type specific requirements
    const productType = document.getElementById('product_type').value;
    const conditionSelect = document.getElementById('condition');
    
    if ((productType === 'thrift' || productType === 'refurbished') && !conditionSelect.value) {
        isValid = false;
        alert('Please select the condition for this ' + productType + ' product.');
        conditionSelect.focus();
        e.preventDefault();
        return;
    }
    
    // Check sale requirements
    const saleCheckbox = document.getElementById('is_on_sale');
    if (saleCheckbox.checked) {
        const originalPrice = parseFloat(document.getElementById('original_price').value);
        const discount = parseFloat(document.getElementById('discount_percentage').value);
        
        if (!originalPrice || originalPrice <= 0) {
            isValid = false;
            alert('Please enter a valid original price for the sale.');
            document.getElementById('original_price').focus();
            e.preventDefault();
            return;
        }
        
        if (!discount || discount < 1 || discount > 90) {
            isValid = false;
            alert('Please enter a discount percentage between 1-90%.');
            document.getElementById('discount_percentage').focus();
            e.preventDefault();
            return;
        }
    }
    
    if (!isValid) {
        e.preventDefault();
        alert('Please fill in all required fields.');
        return;
    }
    
    // Check if variations are properly configured
    if (selectedVariationTypes.size > 0) {
        let hasConfiguredVariations = false;
        selectedVariationTypes.forEach(typeId => {
            const checkboxes = document.querySelectorAll(`input[name^="variation_${typeId}_"]:checked`);
            if (checkboxes.length > 0) {
                hasConfiguredVariations = true;
            }
        });
        
        if (!hasConfiguredVariations) {
            if (!confirm('You selected variation types but haven\'t configured any specific options. Continue without variations?')) {
                e.preventDefault();
                return;
            }
        }
    }
});
</script>

{% endblock %}