<div class="row">
    <div class="col-md-6">
        <h6><i class="fa fa-info-circle"></i> Order Information</h6>
        <table class="table table-sm">
            <tr><td><strong>Order Number:</strong></td><td>#{{ order.order_number|default:order.id }}</td></tr>
            <tr><td><strong>Order Date:</strong></td><td>{{ order.created_at|date:"M d, Y H:i" }}</td></tr>
            <tr><td><strong>Status:</strong></td><td>
                {% with status=order.get_effective_status %}
                    {% if status == 'pending' %}
                        <span class="badge badge-info">‚è≥ Pending</span>
                    {% elif status == 'confirmed' %}
                        <span class="badge badge-success">‚úÖ Confirmed</span>
                    {% elif status == 'processing' %}
                        <span class="badge badge-warning">üîÑ Processing</span>
                    {% elif status == 'shipped' %}
                        <span class="badge badge-primary">üöö Shipped</span>
                    {% elif status == 'delivered' %}
                        <span class="badge badge-success">üì¶ Delivered</span>
                    {% elif status == 'completed' %}
                        <span class="badge badge-success">‚úÖ Completed</span>
                    {% elif status == 'cancelled' %}
                        <span class="badge badge-danger">‚ùå Cancelled</span>
                    {% else %}
                        <span class="badge badge-secondary">{{ status|title }}</span>
                    {% endif %}
                {% endwith %}
            </td></tr>
            <tr><td><strong>Payment Method:</strong></td><td>{{ order.payment_method|default:"N/A" }}</td></tr>
            <tr><td><strong>Payment Status:</strong></td><td>
                {% if order.payment_status == 'completed' %}
                    <span class="badge badge-success">‚úÖ Paid</span>
                {% elif order.payment_status == 'pending_verification' %}
                    <span class="badge badge-warning">üîç Verifying</span>
                {% elif order.payment_status == 'cod_pending' %}
                    <span class="badge badge-info">üí∞ COD</span>
                {% elif order.payment_status == 'rejected' %}
                    <span class="badge badge-danger">‚ùå Rejected</span>
                {% else %}
                    <span class="badge badge-secondary">{{ order.payment_status|title }}</span>
                {% endif %}
            </td></tr>
            <tr><td><strong>Total Amount:</strong></td><td><strong class="text-success">Rs. {{ order.grand_total|floatformat:2 }}</strong></td></tr>
        </table>

        <!-- Status Timeline -->
        <h6><i class="fa fa-clock"></i> Order Timeline</h6>
        <div class="timeline-container" style="max-height: 200px; overflow-y: auto;">
            <ul class="list-unstyled">
                <li class="mb-2">
                    <small class="text-muted">{{ order.created_at|date:"M d, Y H:i" }}</small><br>
                    <i class="fa fa-plus-circle text-info"></i> <strong>Order Placed</strong>
                </li>
                
                {% if order.confirmed_at %}
                <li class="mb-2">
                    <small class="text-muted">{{ order.confirmed_at|date:"M d, Y H:i" }}</small><br>
                    <i class="fa fa-check-circle text-success"></i> <strong>Order Confirmed</strong>
                </li>
                {% endif %}
                
                {% if order.processing_at %}
                <li class="mb-2">
                    <small class="text-muted">{{ order.processing_at|date:"M d, Y H:i" }}</small><br>
                    <i class="fa fa-cog text-warning"></i> <strong>Processing Started</strong>
                </li>
                {% endif %}
                
                {% if order.shipped_at %}
                <li class="mb-2">
                    <small class="text-muted">{{ order.shipped_at|date:"M d, Y H:i" }}</small><br>
                    <i class="fa fa-truck text-primary"></i> <strong>Order Shipped</strong>
                    {% if order.tracking_number %}
                        <br><small class="text-muted">Tracking: {{ order.tracking_number }}</small>
                    {% endif %}
                </li>
                {% endif %}
                
                {% if order.delivered_date %}
                <li class="mb-2">
                    <small class="text-muted">{{ order.delivered_date|date:"M d, Y H:i" }}</small><br>
                    <i class="fa fa-box text-success"></i> <strong>Order Delivered</strong>
                </li>
                {% endif %}
                
                {% if order.completed_date %}
                <li class="mb-2">
                    <small class="text-muted">{{ order.completed_date|date:"M d, Y H:i" }}</small><br>
                    <i class="fa fa-check-circle text-success"></i> <strong>Order Completed</strong>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>

    <div class="col-md-6">
        <h6><i class="fa fa-user"></i> Customer Information</h6>
        <table class="table table-sm">
            <tr><td><strong>Name:</strong></td><td>{{ order.user.get_full_name|default:order.user.username }}</td></tr>
            <tr><td><strong>Email:</strong></td><td>{{ order.user.email }}</td></tr>
            <tr><td><strong>Phone:</strong></td><td>{{ order.user.profile.phone_number|default:"Not provided" }}</td></tr>
            <tr><td><strong>Address:</strong></td><td>
                {{ order.address }}<br>
                {{ order.city }}, {{ order.country }}<br>
                {% if order.zip %}ZIP: {{ order.zip }}{% endif %}
            </td></tr>
        </table>

        <!-- QR Payment Details -->
        {% if order.payment_method == 'QR Payment' %}
        <h6><i class="fa fa-qrcode"></i> QR Payment Details</h6>
        <table class="table table-sm">
            {% if order.payment_reference %}
            <tr><td><strong>Payment Reference:</strong></td><td>{{ order.payment_reference }}</td></tr>
            {% endif %}
            {% if order.qr_payment_transaction_id %}
            <tr><td><strong>Transaction ID:</strong></td><td>{{ order.qr_payment_transaction_id }}</td></tr>
            {% endif %}
            {% if order.qr_payment_confirmed_at %}
            <tr><td><strong>Payment Submitted:</strong></td><td>{{ order.qr_payment_confirmed_at|date:"M d, Y H:i" }}</td></tr>
            {% endif %}
            {% if order.qr_payment_verified_at %}
            <tr><td><strong>Payment Verified:</strong></td><td>{{ order.qr_payment_verified_at|date:"M d, Y H:i" }}</td></tr>
            {% endif %}
        </table>
        {% endif %}
    </div>
</div>

<hr>

<h6><i class="fa fa-shopping-cart"></i> Order Items</h6>
<div class="table-responsive">
    <table class="table table-sm table-striped">
        <thead class="thead-light">
            <tr>
                <th>Product</th>
                <th>Variations</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in order_items %}
            <tr>
                <td>
                    <strong>{{ item.product.name }}</strong><br>
                    <small class="text-muted">{{ item.product.description|truncatewords:8 }}</small>
                </td>
                <td>
                    {% if item.variations.exists %}
                        {% for variation in item.variations.all %}
                            <span class="badge badge-light">{{ variation.variation_type.display_name }}: {{ variation.variation_option.get_display_value }}</span><br>
                        {% endfor %}
                    {% else %}
                        <small class="text-muted">No variations</small>
                    {% endif %}
                </td>
                <td><span class="badge badge-primary">{{ item.quantity }}</span></td>
                <td>Rs. {{ item.get_unit_price|floatformat:2 }}</td>
                <td><strong>Rs. {{ item.price|floatformat:2 }}</strong></td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="table-active">
                <td colspan="4"><strong>Subtotal:</strong></td>
                <td><strong>Rs. {{ order.total|floatformat:2 }}</strong></td>
            </tr>
            <tr class="table-active">
                <td colspan="4"><strong>Tax (13%):</strong></td>
                <td><strong>Rs. {{ order.tax|floatformat:2 }}</strong></td>
            </tr>
            <tr class="table-success">
                <td colspan="4"><strong>Grand Total:</strong></td>
                <td><strong>Rs. {{ order.grand_total|floatformat:2 }}</strong></td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Shipping Information -->
{% if order.tracking_number or order.shipped_at %}
<hr>
<h6><i class="fa fa-truck"></i> Shipping Information</h6>
<div class="row">
    <div class="col-md-6">
        <table class="table table-sm">
            {% if order.tracking_number %}
            <tr><td><strong>Tracking Number:</strong></td><td>
                <span class="badge badge-info">{{ order.tracking_number }}</span>
            </td></tr>
            {% endif %}
            {% if order.shipped_at %}
            <tr><td><strong>Shipped Date:</strong></td><td>{{ order.shipped_at|date:"M d, Y H:i" }}</td></tr>
            {% endif %}
            {% if order.shipping_date %}
            <tr><td><strong>Shipping Date:</strong></td><td>{{ order.shipping_date|date:"M d, Y" }}</td></tr>
            {% endif %}
        </table>
    </div>
    <div class="col-md-6">
        {% if order.shipping_notes %}
        <strong>Shipping Notes:</strong>
        <div class="alert alert-light">{{ order.shipping_notes }}</div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Delivery Information -->
{% if order.delivered_date or order.delivery_notes %}
<hr>
<h6><i class="fa fa-box"></i> Delivery Information</h6>
<div class="row">
    <div class="col-md-6">
        <table class="table table-sm">
            {% if order.delivered_date %}
            <tr><td><strong>Delivered Date:</strong></td><td>{{ order.delivered_date|date:"M d, Y H:i" }}</td></tr>
            {% endif %}
            {% if order.delivery_date %}
            <tr><td><strong>Delivery Date:</strong></td><td>{{ order.delivery_date|date:"M d, Y" }}</td></tr>
            {% endif %}
        </table>
    </div>
    <div class="col-md-6">
        {% if order.delivery_notes %}
        <strong>Delivery Notes:</strong>
        <div class="alert alert-success">{{ order.delivery_notes }}</div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Action Buttons -->
<hr>
<div class="text-center">
    {% with status=order.get_effective_status %}
        {% if status == 'pending' %}
            <button class="btn btn-success" onclick="updateOrderStatus({{ order.id }}, 'confirmed')">
                <i class="fa fa-check"></i> Confirm Order
            </button>
        {% elif status == 'confirmed' %}
            <button class="btn btn-warning" onclick="updateOrderStatus({{ order.id }}, 'processing')">
                <i class="fa fa-cog"></i> Start Processing
            </button>
        {% elif status == 'processing' %}
            <button class="btn btn-primary" onclick="$('#orderDetailsModal').modal('hide'); markAsShipped({{ order.id }});">
                <i class="fa fa-truck"></i> Mark as Shipped
            </button>
        {% elif status == 'shipped' %}
            <button class="btn btn-success" onclick="$('#orderDetailsModal').modal('hide'); markAsDelivered({{ order.id }});">
                <i class="fa fa-box"></i> Mark as Delivered
            </button>
        {% elif status == 'delivered' %}
            <button class="btn btn-info" onclick="updateOrderStatus({{ order.id }}, 'completed')">
                <i class="fa fa-check-circle"></i> Complete Order
            </button>
        {% endif %}
    {% endwith %}
    
    <button class="btn btn-outline-primary" onclick="contactCustomer('{{ order.user.username }}')">
        <i class="fa fa-comment"></i> Message Customer
    </button>
</div>